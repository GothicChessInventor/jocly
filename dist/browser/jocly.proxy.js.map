{"version":3,"sources":["jocly.proxy.js"],"names":["gameConfigs","gameIdRef","messageListenerInstalled","games","msgIdRef","messageReplies","MessageListener","event","game","data","joclyEmbeddedGameId","console","info","replyId","reply","message","listeners","forEach","listener","call","GameProxyClass","gameName","id","prototype","attachElement","element","options","self","promise","Promise","resolve","reject","window","addEventListener","iframeUrl","iframe","document","createElement","attrs","name","frameborder","src","SystemJS","getConfig","baseURL","width","height","Object","keys","attr","setAttribute","assign","style","position","top","right","bottom","left","whiteSpace","wrapper","appendChild","onload","PostMessage","type","contentWindow","postMessage","listen","push","unlisten","i","length","splice","humanTurn","machineTurn","getFinished","result","getMoveString","move","CreateGame","config","Jocly","listGames","then","gameDescr","Error","import","module","WorkerGlobalScope","GameProxy","createGame","exports"],"mappings":"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","file":"jocly.proxy.js","sourcesContent":["/*    Copyright 2017 Jocly\n *\n *    This program is free software: you can redistribute it and/or  modify\n *    it under the terms of the GNU Affero General Public License, version 3,\n *    as published by the Free Software Foundation.\n *\n *    This program is distributed in the hope that it will be useful,\n *    but WITHOUT ANY WARRANTY; without even the implied warranty of\n *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *    GNU Affero General Public License for more details.\n *\n *    You should have received a copy of the GNU Affero General Public License\n *    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n *\n *    As a special exception, the copyright holders give permission to link the\n *    code of portions of this program with the OpenSSL library under certain\n *    conditions as described in each individual source file and distribute\n *    linked combinations including the program with the OpenSSL library. You\n *    must comply with the GNU Affero General Public License in all respects\n *    for all of the code used other than as permitted herein. If you modify\n *    file(s) with this exception, you may extend this exception to your\n *    version of the file(s), but you are not obligated to do so. If you do not\n *    wish to do so, delete this exception statement from your version. If you\n *    delete this exception statement from all source files in the program,\n *    then also delete it in the license file.\n */\n\nvar gameConfigs = {}\nvar gameIdRef = 0;\nvar messageListenerInstalled = false;\nvar games = {};\nvar msgIdRef = 0;\nvar messageReplies = {};\n\nfunction MessageListener(event) {\n    var game = games[event.data.joclyEmbeddedGameId];\n    console.info(\"proxy receives message\",event.data);\n    if(game) {\n        var replyId = event.data.replyId;\n        if(replyId) {\n            var reply = messageReplies[replyId];\n            if(reply) {\n                delete messageReplies[replyId];\n                reply(event.data.message);\n            }\n        } else \n            game.listeners.forEach((listener)=>{\n                listener.call(game,event.data.message);\n            });\n    }\n}\n\nfunction GameProxyClass(gameName) {\n    this.gameName = gameName;\n    this.listeners = [];\n    this.id = ++gameIdRef;\n}\n\nGameProxyClass.prototype.attachElement = function(element,options) {\n    var self = this;\n    var promise = new Promise((resolve,reject)=>{\n        if(!messageListenerInstalled) {\n            messageListenerInstalled = true;\n            window.addEventListener(\"message\",MessageListener);\n        }\n\n        this.element = element;\n        var iframeUrl = \"jocly.embed.html\";\n\n        var iframe = document.createElement(\"iframe\");\n        var attrs = {\n            name: \"jocly-embedded-\"+self.id,\n            frameborder: 0,\n            src: SystemJS.getConfig().baseURL+iframeUrl,\n            width: \"100%\",\n            height: \"100%\"\n        }\t\t\t\n        Object.keys(attrs).forEach((attr)=>{\n            iframe.setAttribute(attr,attrs[attr]);\n        });\n        Object.assign(iframe.style,{\n            position: \"absolute\",\n\t\t\ttop: 0,\n\t\t\tright: 0,\n\t\t\tbottom: 0,\n\t\t\tleft: 0,\n\t\t\twhiteSpace: \"normal\",\n        });\n\n        var wrapper = document.createElement(\"div\");\n        Object.assign(wrapper.style,{\n            position: \"relative\",\n            whiteSpace: \"nowrap\",\n            width: \"100%\",\n            height: \"100%\"\n        });\n        wrapper.appendChild(iframe);\n        element.appendChild(wrapper);\n\n        this.iframe = iframe;\n\n        iframe.onload = ()=>{\n            PostMessage(self,{\n                type: \"init\",\n                id: this.id,\n                gameName: this.gameName\n            },(reply)=>{\n                resolve();\n            });\n        };\n\n    });\n    return promise;\n}\n\nfunction PostMessage(game,message,reply) {\n    var wrapper = {\n        message: message\n    }\n    if(reply) {\n        var replyId = ++msgIdRef;\n        wrapper.replyId = replyId;\n        messageReplies[replyId] = reply;\n    }\n    game.iframe.contentWindow.postMessage(wrapper,\"*\");\n}\n\nGameProxyClass.prototype.listen = function(listener) {\n    var self = this;\n    var promise = new Promise((resolve,reject)=>{\n        self.listeners.push(listener);\n        resolve();\n    });\n    return promise;\n}\n\nGameProxyClass.prototype.unlisten = function(listener) {\n    var self = this;\n    var promise = new Promise((resolve,reject)=>{\n        for(var i = self.listeners.length-1;i>=0;i--)\n            if(self.listeners[i]==listener)\n                self.listeners.splice(i,1);\n        resolve();\n    });\n    return promise;\n}\n\nGameProxyClass.prototype.humanTurn = function() {\n    var self = this;\n    var promise = new Promise((resolve,reject)=>{\n        PostMessage(self,{\n            type: \"humanTurn\"\n        });\n        resolve();\n    });\n    return promise;\n}\n\nGameProxyClass.prototype.machineTurn = function(options) {\n    var self = this;\n    var promise = new Promise((resolve,reject)=>{\n        PostMessage(self,{\n            type: \"machineTurn\",\n            options: options\n        });\n        resolve();\n    });\n    return promise;\n}\n\nGameProxyClass.prototype.getFinished = function() {\n    var self = this;\n    var promise = new Promise((resolve,reject)=>{\n        PostMessage(self,{\n            type: \"getFinished\"\n        },(result) => {\n            resolve(result);\n        });\n    });\n    return promise;\n}\n\nGameProxyClass.prototype.getMoveString = function(move) {\n    var self = this;\n    var promise = new Promise((resolve,reject)=>{\n        PostMessage(self,{\n            type: \"getMoveString\",\n            move: move\n        },(move) => {\n            resolve(move);\n        });\n    });\n    return promise;\n}\n\nfunction CreateGame(gameName) {\n    var promise = new Promise((resolve,reject)=>{\n\n        function CreateGame(config) {\n            var game = new GameProxyClass(gameName);\n            games[game.id] = game;\n            Object.assign(game,config);\n            resolve(game);\n        }\n\n        var config = gameConfigs[gameName];\n        if(config)\n            CreateGame(config);\n        else {\n            Jocly.listGames()\n                .then((games)=>{\n                    var gameDescr = games[gameName];\n                    if (!gameDescr)\n                        return reject(new Error(\"Game \" + gameName + \" not found\"));\n                    SystemJS.import(\"games/\" + gameDescr.module + \"/\" + gameName + \"-config.js\")\n                        .then((config)=>{\n                            gameConfigs[gameName] = config;\n                            CreateGame(config);\n                        });\n\n                },reject);\n        }\n    });\n    return promise;\n}\n\nif (typeof WorkerGlobalScope !== 'undefined' && self instanceof WorkerGlobalScope)\n    this.GameProxy = {\n        createGame: CreateGame\n    }\nelse\n    exports.createGame = CreateGame;\n"]}