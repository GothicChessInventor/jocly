"use strict";function MessageListener(e){var t=games[e.data.joclyEmbeddedGameId];if(console.info("proxy receives message",e.data),t){var s=e.data.replyId;if(s){var n=messageReplies[s];n&&(delete messageReplies[s],n(e.data.message))}else t.listeners.forEach(function(s){s.call(t,e.data.message)})}}function GameProxyClass(e){this.gameName=e,this.listeners=[],this.id=++gameIdRef}function PostMessage(e,t,s){var n={message:t};if(s){var a=++msgIdRef;n.replyId=a,messageReplies[a]=s}e.iframe.contentWindow.postMessage(n,"*")}function CreateGame(e){return new Promise(function(t,s){function n(s){var n=new GameProxyClass(e);games[n.id]=n,Object.assign(n,s),t(n)}var a=gameConfigs[e];a?n(a):Jocly.listGames().then(function(t){var a=t[e];if(!a)return s(new Error("Game "+e+" not found"));SystemJS.import("games/"+a.module+"/"+e+"-config.js").then(function(t){gameConfigs[e]=t,n(t)})},s)})}var gameConfigs={},gameIdRef=0,messageListenerInstalled=!1,games={},msgIdRef=0,messageReplies={};GameProxyClass.prototype.attachElement=function(e,t){var s=this,n=this;return new Promise(function(t,a){messageListenerInstalled||(messageListenerInstalled=!0,window.addEventListener("message",MessageListener)),s.element=e;var i=document.createElement("iframe"),o={name:"jocly-embedded-"+n.id,frameborder:0,src:SystemJS.getConfig().baseURL+"jocly.embed.html",width:"100%",height:"100%"};Object.keys(o).forEach(function(e){i.setAttribute(e,o[e])}),Object.assign(i.style,{position:"absolute",top:0,right:0,bottom:0,left:0,whiteSpace:"normal"});var r=document.createElement("div");Object.assign(r.style,{position:"relative",whiteSpace:"nowrap",width:"100%",height:"100%"}),r.appendChild(i),e.appendChild(r),s.iframe=i,i.onload=function(){PostMessage(n,{type:"init",id:s.id,gameName:s.gameName},function(e){t()})}})},GameProxyClass.prototype.listen=function(e){var t=this;return new Promise(function(s,n){t.listeners.push(e),s()})},GameProxyClass.prototype.unlisten=function(e){var t=this;return new Promise(function(s,n){for(var a=t.listeners.length-1;a>=0;a--)t.listeners[a]==e&&t.listeners.splice(a,1);s()})},GameProxyClass.prototype.humanTurn=function(){var e=this;return new Promise(function(t,s){PostMessage(e,{type:"humanTurn"}),t()})},GameProxyClass.prototype.machineTurn=function(e){var t=this;return new Promise(function(s,n){PostMessage(t,{type:"machineTurn",options:e}),s()})},GameProxyClass.prototype.getFinished=function(){var e=this;return new Promise(function(t,s){PostMessage(e,{type:"getFinished"},function(e){t(e)})})},GameProxyClass.prototype.getMoveString=function(e){var t=this;return new Promise(function(s,n){PostMessage(t,{type:"getMoveString",move:e},function(e){s(e)})})},"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?(void 0).GameProxy={createGame:CreateGame}:exports.createGame=CreateGame;