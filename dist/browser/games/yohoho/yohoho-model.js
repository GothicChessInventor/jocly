exports.model=Model={Game:{},Board:{},Move:{}},Model.Game.HexInitRCPosAndLayout=function(){for(var i=this.mOptions.maxLines,t=[],e=[],s=0,o=0;o<this.mOptions.maxLines;o++){t[o]=[],e[o]=[];for(var r=0;r<this.mOptions.maxCols;r++)t[o][r]=this.mOptions.boardLayout[i-1-o][r],"."!=t[o][r]?(e[o][r]=s,s++):e[o][r]=-1}this.g.rcPositions=e,this.g.Layout=t,this.g.nbPos=s},Model.Game.HexRcPos=function(i,t){return this.g.rcPositions[i][t]},Model.Game.HexIsCell=function(i,t){return!(i<0||i>=this.mOptions.maxLines||t<0||t>=this.mOptions.maxCols)&&"."!=this.g.Layout[i][t]},Model.Game.HexInitGame=function(){this.HexInitRCPosAndLayout(),this.g.orientation=this.mOptions.orientation,this.g.maxNbCellsPerMove=this.mOptions.maxNbCellsPerMove,this.g.margin=this.mOptions.margin;for(var i=[],t=[],e=0;e<this.mOptions.maxLines;e++)for(var s=0;s<this.mOptions.maxCols;s++)if(this.HexIsCell(e,s)){var o=this.HexRcPos(e,s);if(t[o]=[e,s],i[o]=[],"onASide"==this.g.orientation)for(var r=0;r<6;r++)switch(r){case 0:this.HexIsCell(e+1,s+1)?i[o].push(this.HexRcPos(e+1,s+1)):i[o].push(null);break;case 1:this.HexIsCell(e+2,s)?i[o].push(this.HexRcPos(e+2,s)):i[o].push(null);break;case 2:this.HexIsCell(e+1,s-1)?i[o].push(this.HexRcPos(e+1,s-1)):i[o].push(null);break;case 3:this.HexIsCell(e-1,s-1)?i[o].push(this.HexRcPos(e-1,s-1)):i[o].push(null);break;case 4:this.HexIsCell(e-2,s)?i[o].push(this.HexRcPos(e-2,s)):i[o].push(null);break;case 5:this.HexIsCell(e-1,s+1)?i[o].push(this.HexRcPos(e-1,s+1)):i[o].push(null)}else for(var r=0;r<6;r++)switch(r){case 0:this.HexIsCell(e,s+2)?i[o].push(this.HexRcPos(e,s+2)):i[o].push(null);break;case 1:this.HexIsCell(e+1,s+1)?i[o].push(this.HexRcPos(e+1,s+1)):i[o].push(null);break;case 2:this.HexIsCell(e+1,s-1)?i[o].push(this.HexRcPos(e+1,s-1)):i[o].push(null);break;case 3:this.HexIsCell(e,s-2)?i[o].push(this.HexRcPos(e,s-2)):i[o].push(null);break;case 4:this.HexIsCell(e-1,s-1)?i[o].push(this.HexRcPos(e-1,s-1)):i[o].push(null);break;case 5:this.HexIsCell(e-1,s+1)?i[o].push(this.HexRcPos(e-1,s+1)):i[o].push(null)}}this.g.Graph=i,this.g.Coord=t},Model.Game.DestroyGame=function(){},Model.Board.xtraInitBoard=function(i){},Model.Board.HexInit=function(i){var t=i.mOptions.maxCols,e=i.mOptions.maxLines;this.board=[];var s=-1;void 0!=i.mOptions.boardInitValue&&(s=i.mOptions.boardInitValue);for(var o=0;o<e;o++)for(var r=0;r<t;r++)this.board[i.HexRcPos(o,r)]=s;var a=i.mOptions.initial;this.pieces=[];var h=0,n=[{},{}];if(a)for(var c=0;c<e;c++)for(var o=e-1-c,r=0;r<t;r++){var p=i.HexRcPos(o,r);switch(a.a[c][r]){case".":case"#":break;default:var l=a.a[c][r],m=n[0][l];void 0===m&&(n[0][l]=0),this.pieces.push({s:JocGame.PLAYER_A,pos:p,type:l,alive:!0,index:n[0][l]++}),this.board[p]=h++}switch(a.b[c][r]){case".":case"#":break;default:var l=a.b[c][r],m=n[1][l];void 0===m&&(n[1][l]=0),this.pieces.push({s:JocGame.PLAYER_B,pos:p,type:l,alive:!0,index:n[1][l]++}),this.board[p]=h++}}},Model.Game.InitGame=function(){this.HexInitGame(),this.g.GetStrengthByType=function(i){switch(i){case"C":return 5;case"c":return 3;case"p":return 2;default:return 0}},this.g.distAmiralToLastRowSubFactor={"-1":10,0:0,1:-10},this.g.distAmiralToLastRowFactor=3,this.g.pieceWeight={c:2,p:1,C:0,r:0},this.g.weightFactor=3,this.g.GainOtherAmiralDist=[0,15,4,2,1,.7,.6,.5,.4,.3,.2,.1,0],this.g.GainSelfAmiralDist=[0,5,4,2,1,.7,.6,.5,.4,.3,.2,.1,0],this.g.gainOtherAmiralDistSubFactor=1,this.g.gainSelfAmiralDistSubFactor=1,this.g.yohohoFactor=2,this.g.MoveCount=22;var i=this;this.g.Dist=function(t,e){if(t==e)return 0;if(e<t){var s=t;t=e,e=s}return i.g.DistArray[t][e-t-1]};var t=this.g.Graph.length;this.g.DistArray=[];for(var e=0;e<t-1;e++){for(var s=[],o=0;o<t-e;o++)s.push(-1);this.g.DistArray.push(s)}this.g.SetDist=function(t,e,s){if(t!=e){if(e<t){var o=t;t=e,e=o}i.g.DistArray[t][e-t-1]=s}};for(var r=0;r<t;r++)this.YohohoEachDirection(r,function(t){if(r<t){i.g.Dist(r,t)<0&&i.g.SetDist(r,t,1)}return!0});for(var r=0;r<t;r++)this.YohohoEachDirection(r,function(e){if(r<e)for(var s=0;s<t;s++){var o=i.g.Dist(s,r);if(o>=0){var a=i.g.Dist(s,e);(a==-1||o+1<a)&&i.g.SetDist(s,e,o+1)}}return!0})},Model.Move.Init=function(i){void 0!==i&&this.CopyFrom(i)},Model.Move.CopyFrom=function(i){if(this.t=i.t,"m"==i.t)this.m=[{f:i.m[0].f,t:i.m[0].t},{f:i.m[1].f,t:i.m[1].t}];else if("a"==i.t){this.af=[];for(var t in i.af)this.af.push(i.af[t]);this.at=i.at}},Model.Move.ToString=function(){var i;return"m"==this.t?(i="M "+this.m[0].f+">"+this.m[0].t,void 0!==this.m[1].f&&(i+=" "+this.m[1].f+">"+this.m[1].t)):i="A "+this.af.join(",")+">"+this.at,i},Model.Board.InitialPosition=function(i){this.HexInit(i),this.first=!0,this.yohoho=!1,this.amirals={};for(var t in this.pieces){var e=this.pieces[t];"C"==e.type&&(this.amirals[e.s]=t),e.s==JocGame.PLAYER_A?e.angle=0:e.angle=180}this.piecesWeight={"-1":8,1:8}},Model.Board.GenerateMoves=function(i){function t(i,t){if(i.index==t.index)return!1;for(var e in i.reqEmpty){var s=i.reqEmpty[e];if(o.board[s]!=-1)return!1}for(var e in t.reqEmpty){var s=t.reqEmpty[e];if(s==i.t)return!1;if(o.board[s]!=-1&&s!=i.f)return!1}return i.t!=t.t}var e=!1,s=i.g.MoveCount;void 0!==i.mLevelInfo&&(void 0!==i.mLevelInfo.rowRaceLevel&&(e=i.mCurrentLevel>=0&&i.mCurrentLevel<=i.mLevelInfo.rowRaceLevel),void 0!==i.mLevelInfo.moveCount&&(s=i.mLevelInfo.moveCount));var o=this,r=this.pieces[this.amirals[this.mWho]].pos,a=this.pieces[this.amirals[-this.mWho]].pos,h=i.g.Coord[a][0],n=h-this.mWho,c={},p=[],l=[],m=this.pieces;e&&(m=[this.pieces[this.amirals[this.mWho]]]);for(var f in m){var v=m[f];if(v.s==this.mWho&&v.alive){var u=this.YohohoReachablePositionsThrough(i,v.pos,v.type);for(var d in u){var g={f:v.pos,t:u[d].pos,index:f,reqEmpty:u[d].reqEmpty},b=0;if("C"==v.type){var y=i.g.Coord[v.pos],x=y[0],A=this.mWho==JocGame.PLAYER_A?8-x:x;y=i.g.Coord[g.t];var C=y[0],G=this.mWho==JocGame.PLAYER_A?8-C:C;0==G&&this.board[g.t]==-1&&l.push(g),b+=12,b+=i.g.distAmiralToLastRowSubFactor[G-A]}else"c"==v.type&&(b+=1);var M=i.g.Dist(g.t,r),R=i.g.Dist(g.t,a),E=i.g.GainSelfAmiralDist[M],D=i.g.GainOtherAmiralDist[R];2!=R||"c"!=v.type&&"p"!=v.type||i.YohohoEachDirection(g.t,function(t){return o.board[t]!=-1||1!=i.g.Dist(t,a)||1!=i.g.Dist(t,r)||i.g.Coord[t][0]!=n||(b+=3,!1)});var L=Math.max(E*i.g.gainSelfAmiralDistSubFactor,D*i.g.gainOtherAmiralDistSubFactor);b+=L,g.eval=b,void 0===c[g.index]&&(c[g.index]=[]),c[g.index].push(g)}}}if(l.length>0)for(var f in l){var g=l[f];this.mMoves.push({t:"m",m:[{f:g.f,t:g.t},{}]})}else{var P=[];for(var Y in c){var H=c[Y];H.sort(function(i,t){return t.eval-i.eval}),P.push(H)}P.sort(function(i,t){return t[0].eval-i[0].eval});for(var W=1,I=0;P.length>0;)p.push(P[I].shift()),0==P[I].length?(P.splice(I,1),W--):I++,I==W&&(W<P.length&&W++,I=0);if(e){var B=[],k=-1;for(var f in p){var g=p[f],F=(i.g.Coord[g.t][0]-i.g.Coord[g.t][0])*this.mWho;F==k?B.push(g):F>k&&(k=F,B=[g])}this.mMoves=this.YohohoCaptures(i,this.mWho);for(var f in B){var g=B[f];this.board[g.t]==-1&&this.mMoves.push({t:"m",m:[{f:g.f,t:g.t},{}]})}return void(0==this.mMoves.length&&(this.mFinished=!0,this.mWinner=JocGame.DRAW))}var S=[],O=this.YohohoAmiralCapture(i,this.mWho);if(O.risk){for(var f in O.capture){var w=O.capture[f],J=JSON.parse(JSON.stringify(w.af));this.mMoves.push({t:"a",af:J,at:w.at})}for(var d=0;d<p.length&&S.length<s;d++)for(var f=0;f<O.escape.length&&S.length<s;f++){var T=this.amirals[this.mWho],_=this.pieces[T],q={f:_.pos,t:O.escape[f].t,index:T,reqEmpty:[O.escape[f].t]};if(p[d].index!=T){var N=t(q,p[d]);N?S.push({t:"m",m:[{f:q.f,t:q.t},{f:p[d].f,t:p[d].t}]}):t(p[d],q)&&S.push({t:"m",m:[{f:p[d].f,t:p[d].t},{f:q.f,t:q.t}]})}}return this.mMoves=this.mMoves.concat(S),void(0==this.mMoves.length&&(this.mFinished=!0,this.mWinner=-this.mWho))}if(this.first)for(var d=0;d<f&&S.length<s;d++)this.board[p[d].t]==-1&&S.push({t:"m",m:[{f:p[d].f,t:p[d].t},{}]});else for(var f=1;f<p.length&&S.length<s;f++)for(var d=0;d<f&&S.length<s;d++)p[f].index!=p[d].index&&(t(p[f],p[d])?S.push({t:"m",m:[{f:p[f].f,t:p[f].t},{f:p[d].f,t:p[d].t}]}):t(p[d],p[f])&&S.push({t:"m",m:[{f:p[d].f,t:p[d].t},{f:p[f].f,t:p[f].t}]}));this.mMoves=this.YohohoCaptures(i,this.mWho),this.mMoves=this.mMoves.concat(S),0==this.mMoves.length&&(this.mFinished=!0,this.mWinner=-this.mWho)}},Model.Board.IsValidMove=function(i,t){return!0},Model.Board.Evaluate=function(i,t,e){this.mEvaluation=0;var s=this.YohohoAmiralCapture(i,JocGame.PLAYER_A);s.risk&&s.end&&(this.mFinished=!0,this.mWinner=JocGame.PLAYER_B);var o=this.YohohoAmiralCapture(i,JocGame.PLAYER_B);o.risk&&o.end&&(this.mFinished=!0,this.mWinner=JocGame.PLAYER_A);var r=this.pieces[this.amirals[JocGame.PLAYER_A]].pos,a=this.pieces[this.amirals[JocGame.PLAYER_B]].pos,h=i.g.Coord[r][0];8==h&&(this.mFinished=!0,this.mWinner=JocGame.PLAYER_A);var n=i.g.Coord[a][0];if(0==n&&(this.mFinished=!0,this.mWinner=JocGame.PLAYER_B),!this.mFinished){var c=i.g.distAmiralToLastRowFactor;switch(i.g.Dist(r,a)){case 1:c=i.g.distAmiralToLastRowFactor;break;case 2:c=1.2*i.g.distAmiralToLastRowFactor;break;default:c=2*i.g.distAmiralToLastRowFactor}this.mEvaluation+=(h-8+n)*c,this.mEvaluation+=(this.piecesWeight[JocGame.PLAYER_A]-this.piecesWeight[JocGame.PLAYER_B])*i.g.weightFactor;var p=0,l=0;for(var m in this.pieces){var f=this.pieces[m];if(f.alive){var v=Math.min(i.g.Dist(f.pos,r),i.g.Dist(f.pos,a));f.s==JocGame.PLAYER_A?p+=v:l+=v}}this.mEvaluation+=.001*(l-p),this.mEvaluation+=(s?-i.g.yohohoFactor:0)+(o?i.g.yohohoFactor:0)}},Model.Board.yohohoUpdateAngle=function(i,t,e,s){var o=0;if(void 0===s||void 0===e)o=0;else{var r=i.g.Coord[e],a=i.g.Coord[s];o=a[1]>r[1]?a[0]>r[0]?-30:a[0]<r[0]?-150:-90:a[0]>r[0]?30:a[0]<r[0]?150:90}t.angle=o},Model.Board.ApplyMove=function(i,t){if("m"==t.t){var e=this.board[t.m[0].f],s=this.pieces[e].s;this.board[t.m[0].f]=-1,this.board[t.m[0].t]=e,this.pieces[e].pos=t.m[0].t,this.yohohoUpdateAngle(i,this.pieces[e],t.m[0].f,t.m[0].t),0==this.first&&void 0!==t.m[1].f&&(e=this.board[t.m[1].f],e<0&&JocLog("!!!! move from nowhere",t),this.board[t.m[1].f]=-1,this.board[t.m[1].t]=e,this.pieces[e].pos=t.m[1].t,this.yohohoUpdateAngle(i,this.pieces[e],t.m[1].f,t.m[1].t));var o=this.YohohoAmiralCapture(i,-s);this.yohoho=o.risk}else if("a"==t.t){var e=this.board[t.at];this.board[t.at]=-1,this.pieces[e].alive=0,this.piecesWeight[-this.mWho]-=i.g.pieceWeight[this.pieces[e].type]}this.first=!1},Model.Board.YohohoReachablePositions=function(i,t,e,s,o){var r=this,a=[],h=0,n=this.pieces[this.board[t]].s,c="YohohoEachDirectionWind";switch(e){case"C":h=1;break;case"c":h=2;break;case"p":h=3;break;case"r":c="YohohoEachDirection"}return i[c](t,function(t,c){for(var p=0;null!=t&&(0==h||p<h)&&(t==s||r.board[t]==-1&&t!=o);){var l=!0;if("C"==e){var m=0;i.YohohoEachDirection(t,function(t){var e=r.board[t];if(e>=0&&r.pieces[e].alive&&r.pieces[e].s==-n){var s=i.g.GetStrengthByType(r.pieces[e].type);m+=s}return!0}),m>5&&(l=!1)}l&&a.push(t),t=i.g.Graph[t][c],p++}return!0}),a},Model.Board.YohohoReachablePositionsThrough=function(i,t,e){var s=this,o=[],r=0,a=this.pieces[this.board[t]].s,h="YohohoEachDirectionWind";switch(e){case"C":r=1;break;case"c":r=2;break;case"p":r=3;break;case"r":h="YohohoEachDirection"}return i[h](t,function(t,h){for(var n=0,c=[];null!=t&&(0==r||n<r)&&(s.board[t]==-1||s.pieces[s.board[t]].s==a);){var p=!0;if("C"==e){var l=0;i.YohohoEachDirection(t,function(t){var e=s.board[t];if(e>=0&&s.pieces[e].alive&&s.pieces[e].s==-a){var o=i.g.GetStrengthByType(s.pieces[e].type);l+=o}return!0}),l>5&&(p=!1)}if(c.push(t),p){var m=[];for(var f in c)m.push(c[f]);o.push({pos:t,reqEmpty:m})}t=i.g.Graph[t][h],n++}return!0}),o},Model.Game.YohohoEachDirection=function(i,t){for(var e=0;e<6;e++){var s=this.g.Graph[i][e];if(null!=s&&0==t(s,e))return}},Model.Game.YohohoEachDirectionWind=function(i,t){for(var e=1;e<6;e++){var s=this.g.Graph[i][e];if(null!=s&&0==t(s,e))return}},Model.Board.YohohoAmiralCapture=function(i,t){var e=this,s={risk:!1},o=this.pieces[this.amirals[t]].pos,r=0,a=[];if(i.YohohoEachDirection(o,function(s){var o=e.board[s];if(o>=0&&e.pieces[o].alive&&e.pieces[o].s==-t){var h=i.g.GetStrengthByType(e.pieces[o].type);h>0&&a.push(o),r+=h}return!0}),r<=5)return s;s.risk=!0,s.attackers=a,s.capture=[];for(var h in a){var n=a[h],c=i.g.GetStrengthByType(this.pieces[n].type);if(r-c<=5){var p=0,l=[];i.YohohoEachDirection(this.pieces[n].pos,function(s){var o=e.board[s];if(o>=0&&e.pieces[o].alive&&e.pieces[o].s==t){var r=i.g.GetStrengthByType(e.pieces[o].type);r>0&&l.push(e.pieces[o].pos),p+=r}return!0}),p>c&&s.capture.push({af:l,at:this.pieces[n].pos})}}return s.escape=[],i.YohohoEachDirectionWind(o,function(r){if(e.board[r]==-1){var a=0;i.YohohoEachDirection(r,function(s){var o=e.board[s];if(o>=0&&e.pieces[o].alive&&e.pieces[o].s==-t){var r=i.g.GetStrengthByType(e.pieces[o].type);a+=r}}),a<=5&&s.escape.push({f:o,t:r})}return!0}),s.end=0==s.escape.length&&0==s.capture.length,s},Model.Board.YohohoCaptures=function(i,t){var e=this,s=[];for(var o in e.pieces){var r=e.pieces[o];if(r.s==-t&&r.alive){var a=i.g.GetStrengthByType(r.type),h=[];if(a>0){var n=0;i.YohohoEachDirection(r.pos,function(s){var o=e.board[s];if(o>=0&&e.pieces[o].alive&&e.pieces[o].s==t){var r=i.g.GetStrengthByType(e.pieces[o].type);r>0&&h.push(s),n+=r}return!0}),n>a&&s.push({t:"a",af:h,at:r.pos})}}}return s};