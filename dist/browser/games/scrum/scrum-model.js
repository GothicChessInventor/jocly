exports.model=Model={Game:{},Board:{},Move:{}},Model.Game.InitGame=function(){for(var i=this.mOptions.width,t=this.mOptions.height,o=[],s=[],r=0;r<t;r++)for(var e=0;e<i;e++){var a=r*i+e;s[a]=[r,e],o[a]=[];for(var n=-1;n<2;n++)for(var h=-1;h<2;h++)0==n&&0==h||(r+n<t&&r+n>=0&&e+h<i&&e+h>=0?o[a].push((r+n)*i+e+h):o[a].push(null))}this.g.Graph=o,this.g.Coord=s,this.zobrist=new JocGame.Zobrist({board:{type:"array",size:this.g.Graph.length,values:["1","-1","-2"]}})},Model.Game.DestroyGame=function(){},Model.Game.ScrumEachDirection=function(i,t){for(var o=0;o<8;o++){var s=this.g.Graph[i][o];null!=s&&t(s,o)}},Model.Move.Init=function(i){void 0!==i.seg&&(this.seg=[{f:i.seg[0].f,t:i.seg[0].t}],void 0!==i.seg[0].b&&(this.seg[0].b=i.seg[0].b),void 0!==i.seg[1]&&(this.seg[1]={f:i.seg[1].f,t:i.seg[1].t},void 0!==i.seg[1].b&&(this.seg[1].b=i.seg[1].b)))},Model.Move.ToString=function(){var i=this.seg[0].f+">"+this.seg[0].t;return void 0!==this.seg[0].b&&(i+=">"+this.seg[0].b),void 0!==this.seg[1]&&(i+=" - "+this.seg[1].f+">"+this.seg[1].t,void 0!==this.seg[1].b&&(i+=">"+this.seg[1].b)),i},Model.Board.Init=function(i){this.zSign=0},Model.Board.InitialPosition=function(i){var t=i.mOptions.width,o=i.mOptions.height,s=i.mOptions.initial;this.first=!0,this.board=[];for(var r=0;r<o;r++)for(var e=0;e<t;e++)this.board[r*t+e]=-1;this.pieces=[];var a=0;for(var n in s.a){var h=s.a[n],c=h[0]*t+h[1];this.pieces.push({s:JocGame.PLAYER_A,p:c,a:180,sc:!1}),this.board[c]=a++,this.zSign=i.zobrist.update(this.zSign,"board","1",c)}for(var n in s.b){var h=s.b[n],c=h[0]*t+h[1];this.pieces.push({s:JocGame.PLAYER_B,p:c,a:0,sc:!1}),this.board[c]=a++,this.zSign=i.zobrist.update(this.zSign,"board","-1",c)}this.ball=s.ball[0]*t+s.ball[1],this.board[this.ball]=-2,this.zSign=i.zobrist.update(this.zSign,"board","-2",this.ball),this.scrum=!1},Model.Board.GenerateMoves=function(i){try{this._GenerateMoves(i)}catch(i){console.error("GenerateMoves: "+i)}},Model.Board._GenerateMoves=function(i){function t(t,o){if(t>o){var s=t;t=o,o=s}var r=t+"/"+o;if(void 0===c[r]){var e=i.g.Coord[t],a=i.g.Coord[o],n=Math.max(Math.abs(e[0]-a[0]),Math.abs(e[1]-a[1]));c[r]=n}return c[r]}function o(t,o,s,r){var e=i.g.Coord[t],a=i.g.Coord[o],n=[0,1,2,3,4,5,6,7];a[0]>e[0]?(n[0]=-1,n[1]=-1,n[2]=-1,s&&(n[3]=-1,n[4]=-1)):a[0]<e[0]&&(n[5]=-1,n[6]=-1,n[7]=-1,s&&(n[3]=-1,n[4]=-1)),a[1]>e[1]?(n[0]=-1,n[3]=-1,n[5]=-1,s&&(n[1]=-1,n[6]=-1)):a[1]<e[1]&&(n[2]=-1,n[4]=-1,n[7]=-1,s&&(n[1]=-1,n[6]=-1));for(var h in n)if(n[h]!=-1){var c=i.g.Graph[t][n[h]];c&&r(c,h)}}function s(i){for(var t in n.pieces){var o=n.pieces[t];o.s==n.mWho&&i(t,o.p)}}function r(t){if(void 0===l[t]){var o=0,s=0,r=0,e=[];i.ScrumEachDirection(t,function(i){var t=n.board[i];t<0?t==-1&&(r++,e.push(i)):n.pieces[t].s==n.mWho?s++:o++});var a={e:r,etab:e,s:s,o:o};return l[t]=a,a}return l[t]}function e(t,o){if(null!=t.b){var s=i.g.Coord[t.b][0];if(0==s&&n.mWho==JocGame.PLAYER_B||s==a-1&&n.mWho==JocGame.PLAYER_A){var r=0;if(i.ScrumEachDirection(t.b,function(i){n.board[i]==-1&&r++}),r>0){0==J&&(E=[],J=!0);var e={seg:[{f:t.f,t:t.t,b:t.b}]};E.push(e)}}}else{var s=i.g.Coord[n.ball][0];if(0==s&&n.mWho==JocGame.PLAYER_B||s==a-1&&n.mWho==JocGame.PLAYER_A){var h=!1,r=0;if(i.ScrumEachDirection(n.ball,function(i){i==t.t?h=!0:n.board[i]==-1&&r++}),h&&r>0){0==J&&(E=[],J=!0);var e={seg:[{f:t.f,t:t.t}]};E.push(e)}}}if(!J){var r=0,c=n.ball;if(null!=t.b&&(c=t.b),null!=o.b&&(c=o.b),i.ScrumEachDirection(c,function(i){n.board[i]<0&&r++,t.t!=i&&o.t!=i||r--,t.f!=i&&o.f!=i||r++}),0!=r){var e={seg:[{f:t.f,t:t.t},{f:o.f,t:o.t}]};null!=t.b&&(e.seg[0].b=t.b),null!=o.b&&(e.seg[1].b=o.b),E.push(e)}}}var a=i.mOptions.height,n=this,h=(new Date).getTime(),c={},l={},b=r(this.ball),v=[],d=i.g.Coord[this.ball][0];if(i.ScrumEachDirection(this.ball,function(t){n.board[t]==-1&&v.push({p:t,c:r(t),g:(i.g.Coord[t][0]-d)*n.mWho})}),this.scrum){var u=-1,f=[];if(i.ScrumEachDirection(this.ball,function(i){var t=n.board[i];t==-1?u=i:t>=0&&n.pieces[t].s==n.mWho&&f.push(t)}),u==-1)return this.mFinished=!0,void(this.mWinner=JocGame.DRAW);for(var p in f){var g=f[p],m=!0;i.ScrumEachDirection(u,function(i){var t=n.board[i];(t==-1||t>=0&&i==n.pieces[g].p)&&(m=!1)}),0==m&&this.mMoves.push({seg:[{f:n.pieces[g].p,t:n.ball,b:u}]})}if(f.length>0)return void(0==this.mMoves.length&&(this.mFinished=!0,this.mWinner=JocGame.DRAW))}var S=[];i.ScrumEachDirection(this.ball,function(i){var t=n.board[i];if(t>=0&&n.pieces[t].s==n.mWho)for(var o in v){var s=v[o],r={i:t,f:i,t:n.ball,b:s.p,c:s.c,g:s.g,d:1};S.push(r)}}),s(function(s,r){function e(i,t){var o={i:s,f:r,t:i,b:null,c:b,g:0,d:t};S.push(o)}var a=t(r,n.ball);1==a?i.ScrumEachDirection(r,function(i){n.board[i]==-1&&e(i,t(i,n.ball))}):a<4?i.ScrumEachDirection(r,function(i){n.board[i]==-1&&e(i,t(i,n.ball))}):o(r,n.ball,!1,function(i){n.board[i]==-1&&e(i,t(i,n.ball))})});for(var p in S){var M=S[p],A=.125*(8-M.c.o)*1+.125*M.c.s*1+.25*(M.g+2)*4+(11-M.d)*(1/11)*2;0==M.e&&(A=-1e3),1==M.e&&(A+=1e3),2==M.e&&(A+=2),M.w=A}S.sort(function(i,t){return t.w-i.w});var E=[];if(this.first){for(var p=0;p<i.mOptions.levelOptions.MIN_MOVES&&p<S.length;p++){var G=S[p],z={seg:[{f:G.f,t:G.t}]};null!=G.b&&(z.seg[0].b=G.b),E.push(z)}return void(this.mMoves=E)}for(var W,J=!1,L=-1,D=0,O={},R={};E.length<i.mOptions.levelOptions.MIN_MOVES&&(W=function(){for(;;){if(L++,L==D&&(D++,L=0),!(D<S.length))return null;var i=S[L],t=S[D];if(!(null!=i.b&&null!=t.b||i.i==t.i||i.t==t.t||t.t==i.b&&null==t.b||t.b==i.t))return[i,t]}}());){var _=W[0];if(e(_,W[1]),null!=_.b&&!_.explored){_.explored=!0;var y=function(t){if(void 0===O[t]){O[t]=[];var o=[],s=[];i.ScrumEachDirection(t,function(i){var t=n.board[i];t==-1?o.push(i):t>=0&&n.pieces[t].s==n.mWho&&s.push(t)});for(var r in s){var e=s[r];for(var a in o)O[t].push({i:e,f:n.pieces[e].p,t:t,b:o[a]})}}return O[t]}(_.b);for(var p in y){var B=y[p];B.i!=_.i&&e(_,B)}var y=function(t){return void 0===R[t]&&(R[t]=[],i.ScrumEachDirection(t,function(i){var o=n.board[i];o>=0&&n.pieces[o].s==n.mWho&&R[t].push({i:o,f:n.pieces[o].p,t:t})})),R[t]}(_.f);for(var p in y){var B=y[p];B.i!=_.i&&e(_,B)}}}var C=[];i.ScrumEachDirection(this.ball,function(i){var t=n.board[i];t>=0&&n.pieces[t].s==n.mWho&&C.push(t)});var P=[];for(var p in C){var Y=i.g.Coord[this.pieces[C[p]].p][0];(this.mWho==JocGame.PLAYER_A&&Y>=d||this.mWho==JocGame.PLAYER_B&&Y<=d)&&P.push(C[p])}var F=E.length;for(var p in P)for(var I in C)if(P[p]!=C[I]){var x=this.pieces[P[p]],w=this.pieces[C[I]];i.ScrumEachDirection(x.p,function(i){n.board[i]==-1&&e({i:P[p],f:x.p,t:i},{i:C[I],f:w.p,t:n.ball,b:x.p})})}var T=E.length-F;this.mMoves=E,0==this.mMoves.length&&this.mMoves.push(function(){var o=[],r=[];s(function(i,o){var s=t(o,n.ball);r.push({i:i,d:s})}),r.sort(function(i,t){return t.d-i.d});for(var e in r){var a=r[e],h=n.pieces[a.i].p,c=t(h,n.ball),l=!1;if(i.ScrumEachDirection(h,function(i){if(!l&&n.board[i]==-1){if(t(i,n.ball)>=c){if(1==o.length&&i==o[0].t)return;o.push({i:a.i,f:h,t:i}),l=!0}}}),2==o.length)return{seg:[{f:o[0].f,t:o[0].t},{f:o[1].f,t:o[1].t}]}}}()),gmStats="undefined"!=typeof gmStats?gmStats:{count:0,time:0,moves:0,segments:0,maxGroup2:0};var N=(new Date).getTime(),V=N-h;gmStats.count++,gmStats.time+=V,gmStats.moves+=E.length,gmStats.segments+=S.length,T>gmStats.maxGroup2&&(gmStats.maxGroup2=T)},Model.Board.Evaluate=function(i,t,o){if(i.GetRepeatOccurence(this)>2)return this.mFinished=!0,void(this.mWinner=JocGame.DRAW);var s=i.mOptions.height,r=this,e=0,a=0,n=0;i.ScrumEachDirection(this.ball,function(i){var t=r.board[i];if(t==-1)e++;else if(t>=0){var o=r.pieces[t];o.s==JocGame.PLAYER_A?a++:n++,0==h&&o.p==JocGame.PLAYER_B?(r.mFinished=!0,r.mWinner=JocGame.PLAYER_B):h==s-1&&o.p==JocGame.PLAYER_A&&(r.mFinished=!0,r.mWinner=JocGame.PLAYER_A)}});var h=i.g.Coord[this.ball][0];0==h&&n>0&&(r.mFinished=!0,r.mWinner=JocGame.PLAYER_B),h==s-1&&a>0&&(r.mFinished=!0,r.mWinner=JocGame.PLAYER_A);var c=h/(s-1),l=1-c,b=c-l,v=0;0==n&&v++,0==a&&v--;var d=0,u=0,f=i.g.Coord[this.ball];for(var p in this.pieces){var g=this.pieces[p],m=i.g.Coord[g.p],S=Math.max(Math.abs(f[0]-m[0]),Math.abs(f[1]-m[1]));g.s==JocGame.PLAYER_A?d+=S:u+=S}this.mEvaluation=b*i.mOptions.levelOptions.ROW_FACTOR+v*i.mOptions.levelOptions.NEIGHBOR_FACTOR+(u-d)*i.mOptions.levelOptions.BDIST_FACTOR},Model.Board.CopyFrom=function(i){this.board=[];for(var t=0;t<i.board.length;t++)this.board.push(i.board[t]);this.pieces=[];for(var o=0;o<i.pieces.length;o++){var s=i.pieces[o];this.pieces.push({s:s.s,p:s.p,a:s.a,sc:s.sc})}this.ball=i.ball,this.scrum=i.scrum,this.first=i.first,this.mWho=i.mWho,this.zSign=i.zSign},Model.Board.ApplyMove=function(i,t){var o=this,s=this.board[t.seg[0].f];if(s<0)return void JocLog("!!! ApplyMove",t,this.board,"seg0: no piece at start");if(this.pieces[s].s!=this.mWho)return void console.error("!!! ApplyMove",t,this.board,"seg0: piece at start is not self");var r=this.board[t.seg[0].t];if(r!=-1&&r!=-2)return void JocLog("!!! ApplyMove",t,this.board,"seg0: cell at dest not avail",r);if(r==-2&&void 0===t.seg[0].b)return void JocLog("!!! ApplyMove",t,this.board,"seg0: to ball but no ball depl");if(r!=-2&&void 0!==t.seg[0].b)return void JocLog("!!! ApplyMove",t,this.board,"seg0: no ball but ball depl");var e=t.seg[0],a=this.board[e.f];if(this.zSign=i.zobrist.update(this.zSign,"board",this.mWho,e.f),this.board[e.f]=-1,this.zSign=i.zobrist.update(this.zSign,"board",this.mWho,e.t),this.board[e.t]=a,this.pieces[s].p=e.t,void 0!==e.b&&(this.zSign=i.zobrist.update(this.zSign,"board",-2,this.ball),this.ball=e.b,this.zSign=i.zobrist.update(this.zSign,"board",-2,this.ball),this.board[this.ball]=-2),void 0!==t.seg[1]){var n=this.board[t.seg[1].f];if(s==n)return void JocLog("!!! ApplyMove",t,this.board,"seg1: move same piece");if(n<0)return JocLog("!!! ApplyMove",t,this.board,"seg1: no piece at start"),void JocLog(t,this);if(this.pieces[n].s!=this.mWho)return void JocLog("!!! ApplyMove",t,this.board,"seg1: piece at start is not self");var h=this.board[t.seg[1].t];if(h!=-1&&h!=-2)return void JocLog("!!! ApplyMove",t,this.board,"seg1: cell at dest not avail");if(h==-2&&void 0===t.seg[1].b)return void JocLog("!!! ApplyMove",t,this.board,"seg1: to ball but no ball depl");if(h!=-2&&void 0!==t.seg[1].b)return void JocLog("!!! ApplyMove",t,this.board,"seg1: no ball but ball depl");var e=t.seg[1],a=this.board[e.f];this.zSign=i.zobrist.update(this.zSign,"board",this.mWho,e.f),this.board[e.f]=-1,this.zSign=i.zobrist.update(this.zSign,"board",this.mWho,e.t),this.board[e.t]=a,this.pieces[n].p=e.t,void 0!==e.b&&(this.zSign=i.zobrist.update(this.zSign,"board",-2,this.ball),this.ball=e.b,this.zSign=i.zobrist.update(this.zSign,"board",-2,this.ball),this.board[this.ball]=-2)}var c=0;i.ScrumEachDirection(this.ball,function(i){o.board[i]==-1&&(c++,o.scrumExit=i)}),this.scrum=!1,1==c?this.scrum=!0:0==c&&JocLog("!!! ApplyMove: ball enclosed");var l={};this.scrum&&i.ScrumEachDirection(this.ball,function(i,t){var s=o.board[i];s>=0&&(l[s]=t)});for(var b=0;b<this.pieces.length;b++){var v=this.pieces[b],d=0;void 0!==l[b]?(d=[135,180,-135,90,-90,45,0,-45][l[b]],v.a=d,v.sc=!0):(v.a=d+(1==v.s?180:0),v.sc=!1)}this.first=!1},Model.Board.IsValidMove=function(i,t){var o=this,s=0,r=this.ball,e=t.seg[0],a=t.seg[1];return e.b&&(r=e.b),a&&a.b&&(r=a.b),i.ScrumEachDirection(r,function(i){o.board[i]<0&&s++,(e.t==i||a&&a.t==i)&&s--,(e.f==i||a&&a.f==i)&&s++}),0!=s||(this.mInvalidMoveMessage=i.mStrings["no-surround"],!1)},Model.Board.GetSignature=function(){return this.zSign};