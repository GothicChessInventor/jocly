{"version":3,"sources":["jocly.core.js"],"names":["WorkerGlobalScope","self","GameProxy","require","exports","listGames","promise","Promise","resolve","reject","SystemJS","import","then","m","baseURL","getConfig","gameName","games","game","thumbnail","module","e","console","warn","gameClassCache","CreateGame","gameDescr","base","model","config","Game","g","Object","assign","prototype","Board","mBoardClass","Move","args","Init","mMoveClass","view","fullPath","name","initArgs","gameOptions","gameClass","createInternalGame","options","gameClassData","WorkerCreateGame","process","title","NodeCreateGame","BrowserCreateGame","t0","Date","now","Error","importScripts","originalExports","gamePromises","all","createGame","element","Element","arguments","attachElement"],"mappings":"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","file":"jocly.core.js","sourcesContent":["/*    Copyright 2017 Jocly\n *\n *    This program is free software: you can redistribute it and/or  modify\n *    it under the terms of the GNU Affero General Public License, version 3,\n *    as published by the Free Software Foundation.\n *\n *    This program is distributed in the hope that it will be useful,\n *    but WITHOUT ANY WARRANTY; without even the implied warranty of\n *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *    GNU Affero General Public License for more details.\n *\n *    You should have received a copy of the GNU Affero General Public License\n *    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n *\n *    As a special exception, the copyright holders give permission to link the\n *    code of portions of this program with the OpenSSL library under certain\n *    conditions as described in each individual source file and distribute\n *    linked combinations including the program with the OpenSSL library. You\n *    must comply with the GNU Affero General Public License in all respects\n *    for all of the code used other than as permitted herein. If you modify\n *    file(s) with this exception, you may extend this exception to your\n *    version of the file(s), but you are not obligated to do so. If you do not\n *    wish to do so, delete this exception statement from your version. If you\n *    delete this exception statement from all source files in the program,\n *    then also delete it in the license file.\n */\n\n\"use strict\";\n\nif (typeof WorkerGlobalScope == 'undefined' || !(self instanceof WorkerGlobalScope)) {\n    var GameProxy = require(\"./jocly.proxy.js\");\n}\n\nexports.listGames = function () {\n\n    var promise = new Promise((resolve, reject) => {\n        if(typeof SystemJS!=\"undefined\")\n            SystemJS.import(\"jocly-allgames.js\").then((m) => {\n                if(typeof SystemJS!=\"undefined\") {\n                    var baseURL = SystemJS.getConfig().baseURL;\n                    for(var gameName in m.games) {\n                        var game = m.games[gameName];\n                        game.thumbnail = baseURL + \"games/\" + game.module + \"/\" + game.thumbnail;\n                    }\n                }\n                resolve(m.games);\n            }, (e) => {\n                console.warn(\"Could not load Jocly games\", e);\n                reject(e);\n            });\n        else\n            resolve(require(\"./jocly-allgames.js\").games);\n    });\n    return promise;\n}\n\nvar gameClassCache = {};\n\nfunction CreateGame(gameName, gameDescr,base, model, config) {\n    var Game = function () {\n        this.g = {}; // some games assume this member exists\n    };\n    Object.assign(Game.prototype, base.Game.prototype, model.model.Game);\n\n    var Board = function () { };\n    Object.assign(Board.prototype, base.Board.prototype, model.model.Board);\n    Game.prototype.mBoardClass = Board;\n\n    var Move = function (args) { this.Init(args); };\n    Object.assign(Move.prototype, base.Move.prototype, model.model.Move);\n    Game.prototype.mMoveClass = Move;\n\n\n    Game.prototype.config = config.config;\n\n    if(typeof SystemJS!=\"undefined\") {\n        Game.prototype.config.baseURL = SystemJS.getConfig().baseURL;\n        Game.prototype.config.view.fullPath = SystemJS.getConfig().baseURL + \"games/\" + gameDescr.module;\n    }\n    Game.prototype.module = gameDescr.module;\n    Game.prototype.name = gameName;\n\n    var initArgs = {\n        game: config.config.model.gameOptions,\n        view: config.config.view\n    };\n\n    gameClassCache[gameName] = {\n        gameClass: Game,\n        initArgs: initArgs\n    }\n\n    var game = new Game();\n\n    game.Init(initArgs);\n\n    return game;\n}\n\nexports.createInternalGame = function (gameName, options) {\n    var gameClassData = gameClassCache[gameName];\n    if(gameClassData) {\n        var promise = new Promise((resolve,reject)=>{\n            var game = new gameClassData.gameClass();\n            game.Init(gameClassData.initArgs);\n            resolve(game);\n        });\n        return promise;\n    }\n    if (typeof WorkerGlobalScope !== 'undefined' && self instanceof WorkerGlobalScope)\n        return WorkerCreateGame(gameName, options);\n    else if(typeof process!==\"undefined\" && process.title === \"node\")\n        return NodeCreateGame(gameName,options);\n    else\n        return BrowserCreateGame(gameName, options);\n}\n\nfunction NodeCreateGame(gameName, options) {\n    var t0 = Date.now();\n    options = options || {};\n    var promise = new Promise((resolve, reject) => {\n\n        var games = require(\"./jocly-allgames.js\").games;\n\n        var gameDescr = games[gameName];\n        if (!gameDescr)\n            return reject(new Error(\"Game \" + gameName + \" not found\"));\n\n        var base = require(\"./jocly.game.js\");\n        var model = require(\"./games/\" + gameDescr.module + \"/\" + gameName + \"-model.js\");\n        var config = require(\"./games/\" + gameDescr.module + \"/\" + gameName + \"-config.js\");\n\n        var game = CreateGame(gameName, gameDescr, base, model, config);\n\n        resolve(game);\n    });\n    return promise;\n}\n\nfunction WorkerCreateGame(gameName, options) {\n    var t0 = Date.now();\n    options = options || {};\n    var promise = new Promise((resolve, reject) => {\n\n        importScripts(\"jocly-allgames.js\");\n        var games = exports.games;\n\n        var gameDescr = games[gameName];\n        if (!gameDescr)\n            return reject(new Error(\"Game \" + gameName + \" not found\"));\n\n        var originalExports = exports;\n        var base = exports = {};\n        importScripts(\"jocly.game.js\");\n        var model = exports = {};\n        importScripts(\"games/\" + gameDescr.module + \"/\" + gameName + \"-model.js\");\n        var config = exports = {};\n        importScripts(\"games/\" + gameDescr.module + \"/\" + gameName + \"-config.js\");\n        exports = originalExports;\n\n        var game = CreateGame(gameName, gameDescr, base, model, config);\n\n        resolve(game);\n    });\n    return promise;\n}\n\nfunction BrowserCreateGame(gameName, options) {\n    options = options || {};\n    var promise = new Promise((resolve, reject) => {\n\n        exports.listGames().then((games) => {\n\n            var gameDescr = games[gameName];\n            if (!gameDescr)\n                return reject(new Error(\"Game \" + gameName + \" not found\"));\n\n            var gamePromises = [\n                SystemJS.import(\"jocly.game.js\"),\n                SystemJS.import(\"games/\" + gameDescr.module + \"/\" + gameName + \"-model.js\"),\n                SystemJS.import(\"games/\" + gameDescr.module + \"/\" + gameName + \"-config.js\")\n            ];\n\n            Promise.all(gamePromises).then(([base, model, config]) => {\n\n                var game = CreateGame(gameName, gameDescr, base, model, config);\n\n                resolve(game);\n            }, (e) => {\n                reject(e);\n            });\n        }, reject);\n\n    });\n    return promise;\n}\n\nexports.createGame = function (gameName) {\n    var options, element;\n    if(typeof Element !== \"undefined\" && arguments[1] instanceof Element) {\n        element = arguments[1];\n        options = arguments[2];\n    } else\n        options = arguments[1];\n\n    var promise = new Promise((resolve,reject)=>{\n        GameProxy.createGame(gameName,options)\n            .then((game)=>{\n                if(element) {\n                    game.attachElement(element,options)\n                        .then(()=>{\n                            resolve(game);\n                        },reject);\n                } else\n                    resolve(game);\n            },reject);\n    });\n    return promise;\n}\n"]}