{"version":3,"sources":["jocly.game.js"],"names":["exports","Game","JocGame","Board","JocBoard","Move","JocMove","e","global","r","require","ju","MersenneTwister","JocUtil","JoclyUCT","PLAYER_A","PLAYER_B","DRAW","document","CLICK","documentElement","MOUSEMOVE_EVENT","MOUSEDOWN_EVENT","MOUSEUP_EVENT","MAX_VALUE","Math","pow","prototype","Init","aOptions","mWho","mViewAs","mTopLevel","mLoopMax","mPreventRepeat","mOptions","game","mViewOptions","view","mSkin","skins","name","mNotation","mShowMoves","useShowMoves","mSounds","sounds","mAutoComplete","level","loopMax","mVisitedBoards","viewAs","mNextSchedule","mPlayedMoves","mFullPlayedMoves","mViewInited","mGameInited","initial","GameInitGame","mBoard","GetBoardClass","InitialPosition","mMoves","listeners","AddListener","listener","push","RemoveListener","i","length","splice","DispatchMessage","message","self","forEach","call","HumanMove","move","type","MachineMove","result","MachineProgress","progress","PlayMove","promise","Promise","resolve","reject","mOldBoard","CopyFrom","ApplyMove","moveShown","PlayedMove","MoveShown","InvertWho","who","GetWho","SetWho","AttachElement","element","options","widget","gamePreAttachProto","Error","systemJSConfig","meta","globals","jQuery","THREE","module","xdview","SystemJS","config","all","import","then","args","Object","getPrototypeOf","gameProto","assign","setPrototypeOf","mBoardClass","boardPreAttachProto","mMoveClass","movePreAttachProto","mGeometry","width","clientWidth","height","clientHeight","mWidget","UpdateSounds","DetachElement","GetMoveClass","CreateMove","CloneBoard","board","newBoard","InitView","console","log","GameInitView","DestroyView","empty","GameDestroyView","CanPlaySound","tag","joclySounds","$","attr","css","display","appendTo","AddSound","path","fname","audio","defaultSounds","useraction","usermove","win","loss","end","baseURL","remove","model","PlaySound","getElementById","mNeedPhonegapMedia","window","cordova","Media","mPhonegapMediaLib","node","firstChild","test","nodeName","getAttribute","nextSibling","src","m","exec","location","pathname","replace","error","warn","code","status","play","cloneNode","InitGame","arguments","mInitial","DestroyGame","GameDestroyGame","aiWorker","terminate","DisplayBoard","Display","aWho","HumanTurn","mCurrentLevel","GenerateMoves","HumanTurnEnd","aMove","aOldBoard","ShowEnd","EvaluateBoard","mFinished","Evaluate","GetFinished","moves","mWinner","IsValidMove","AddVisit","sign","GetSignature","visits","undefined","RemoveVisit","engdbg_loops","engdbg_time","engdbg_t0","StartMachine","Date","now","mDoneCallback","Done","mProgressCallback","Progress","maxDepth","mStartTime","getTime","mExploredCount","mPickedMoveIndex","mBestMoves","mContexts","mDuration","mAborted","mRandomSeed","randomSeed","isNaN","parseInt","StaticGenerateMoves","schedule","levelOptions","levelOptionsSaved","JSON","parse","stringify","aiThread","threaded","Worker","ai","StartThreadedMachine","startMachine","mSavedVisitedBoards","s","Engine","potential","Run","algo","$this","t0","postMessage","onmessage","data","percent","moveIndex","explored","duration","evaluation","playedMoves","gameOptions","gameName","ScheduleStep","ExecuteStep","Random","roof","value","floor","random","ArrayShuffle","arr","j","tmp","mEvaluation","JocLog","stack","tNow","fnt","mAbortCallback","t1","Abort","aAbortCallback","aBoard","aLevel","aBAlpha","aAlpha","aPotential","context","mLevel","mBAlpha","mAlpha","mBestEvaluation","mMoveIndex","mNextBoard","mNextBoards","ExecuteStep2","mExploCtrl","exploFrom","exploTo","QuickEvaluate","MoveSort","bm1","bm2","boardsMoves","MakeAndApply","quickEval","sort","capMoves","slice","topContext","topStep","nextBoard","SetBest","AddBest","pop","GetRepeatOccurence","preventRepeat","repOcc","HandleRepeat","UnhandleRepeat","Equals","BackTo","aIndex","turn","Load","gameData","initialBoard","CloseView","fields","f","ToString","Strip","aGame","InitBoard","mDepth","signature","mSignature","md5","aFinishOnly","aTopLevel","PushMove","GenerateMoveObjects","ExportBoardState","GetBestMatchingMove","moveStr","candidateMoves","prettyMoves","bestDist","Infinity","bestMatches","candidate","index","dist","Levenshtein","max","candidateIndexes","matches","pretty","indexOf","str1","str2","distance","PickMoveFromDatabase","database","key","dbMoves","totalEval","rnd","current","dbMove","pickedMove","CompactMoveString","Zobrist","params","mt","paramNames","seed","pi","param","values","seeds","vIndex","vi","size","seeds0","genrand_int32","update","zobrist","d","b","split","Array","g","a","h","c","k","l"],"mappings":"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","file":"jocly.game.js","sourcesContent":["/*    Copyright 2017 Jocly\n *\n *    This program is free software: you can redistribute it and/or  modify\n *    it under the terms of the GNU Affero General Public License, version 3,\n *    as published by the Free Software Foundation.\n *\n *    This program is distributed in the hope that it will be useful,\n *    but WITHOUT ANY WARRANTY; without even the implied warranty of\n *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *    GNU Affero General Public License for more details.\n *\n *    You should have received a copy of the GNU Affero General Public License\n *    along with this program.  If not, see <http://www.gnu.org/licenses/>.\n *\n *    As a special exception, the copyright holders give permission to link the\n *    code of portions of this program with the OpenSSL library under certain\n *    conditions as described in each individual source file and distribute\n *    linked combinations including the program with the OpenSSL library. You\n *    must comply with the GNU Affero General Public License in all respects\n *    for all of the code used other than as permitted herein. If you modify\n *    file(s) with this exception, you may extend this exception to your\n *    version of the file(s), but you are not obligated to do so. If you do not\n *    wish to do so, delete this exception statement from your version. If you\n *    delete this exception statement from all source files in the program,\n *    then also delete it in the license file.\n */\n\ntry {\n\n\texports.Game = JocGame = function() {}\n\texports.Board = JocBoard = function() {}\n\texports.Move = JocMove = function() {}\n\n} catch(e) {\n\tglobal.JocGame = exports.Game = function() {};\n\tglobal.JocBoard = exports.Board = function() {};\n\tglobal.JocMove = exports.Move = function() {};\n\n\t(function() {\n\t\tvar r = require;\n\t\tvar ju = r(\"./jocly.util.js\");\n\t\tglobal.MersenneTwister = ju.MersenneTwister;\n\t\tglobal.JocUtil = ju.JocUtil;\n\t\tglobal.JoclyUCT = r(\"./jocly.uct.js\").JoclyUCT;\n\t})();\n}\n\nJocGame.PLAYER_A = 1;\nJocGame.PLAYER_B = -1;\nJocGame.DRAW = 2;\n\nif(typeof document!=\"undefined\")\n\tJocGame.CLICK=('ontouchstart' in document.documentElement)?\"touchstart\":\"click\";\nelse\n\tJocGame.CLICK=\"click\";\n/*\nJocGame.MOUSEMOVE_EVENT=('ontouchstart' in document.documentElement)?\"touchmove\":\"mousemove\";\nJocGame.MOUSEDOWN_EVENT=('ontouchstart' in document.documentElement)?\"touchstart\":\"mousedown\";\nJocGame.MOUSEUP_EVENT=('ontouchstart' in document.documentElement)?\"touchend\":\"mouseup\";\n*/\n\nJocGame.MOUSEMOVE_EVENT=\"touchmove mousemove\";\nJocGame.MOUSEDOWN_EVENT=\"touchstart mousedown\";\nJocGame.MOUSEUP_EVENT=\"touchend mouseup joclyclick\";\n\n/* biggest integer with unit precision: \n   Math.pow(2,53)-1 < Math.pow(2,53) is true \n   Math.pow(2,54)-1 < Math.pow(2,54) is false */\nJocGame.MAX_VALUE = Math.pow(2,53); \n\nJocGame.prototype = {}\n\nJocGame.prototype.Init = function(aOptions) {\n\tthis.mWho = JocGame.PLAYER_A;\n\tthis.mViewAs = JocGame.PLAYER_A;\n\tthis.mTopLevel = 3;\n\tthis.mLoopMax = 300;\n\tthis.mPreventRepeat = false;\n\tif(aOptions) {\n\t\tthis.mOptions = aOptions.game;\n\t\tthis.mViewOptions = aOptions.view;\n\t\tthis.mSkin = this.mViewOptions.skins[0].name; // TODO check if 3D not supported\n\t\tthis.mNotation=false;\n\t\tthis.mShowMoves=this.mViewOptions.useShowMoves;\n\t\tthis.mSounds=!!this.mViewOptions.sounds;\n\t\tthis.mAutoComplete=false;\n\n\t\tif(typeof(this.mOptions.level)!=\"undefined\")\n\t\t\tthis.mTopLevel = this.mOptions.level;\n\t\tif (typeof(this.mOptions.loopMax)!=\"undefined\")\n\t\t\tthis.mLoopMax = this.mOptions.loopMax;\n\t\tthis.mVisitedBoards = {};\n\t\tif(typeof(this.mOptions.viewAs)!=\"undefined\")\n\t\t\tthis.mViewAs = this.mOptions.viewAs;\n\t}\n\tthis.mNextSchedule = null;\n\tthis.mPlayedMoves = [];\n\tthis.mFullPlayedMoves = [];\n\tthis.mViewInited = false;\n\tthis.mGameInited = false;\n\tif(aOptions && aOptions.initial)\n\t\tthis.GameInitGame(aOptions.initial);\n\telse\n\t\tthis.GameInitGame();\n\tthis.mBoard = new (this.GetBoardClass())(this);\n\tif(this.mBoard.InitialPosition)\n\t\tthis.mBoard.InitialPosition(this);\n\tthis.mBoard.mMoves=[];\n\tthis.mBoard.mWho = this.mWho;\n\tthis.listeners = [];\n\n}\n\nJocGame.prototype.AddListener = function(listener) {\n\tthis.listeners.push(listener);\n}\n\nJocGame.prototype.RemoveListener = function(listener) {\n\tfor(var i=this.listeners.length-1;i>=0;i--)\n\t\tif(this.listeners[i]==listener)\n\t\t\tthis.listeners.splice(i,1);\n}\n\nJocGame.prototype.DispatchMessage = function(message) {\n\tvar self = this;\n\tthis.listeners.forEach(function(listener) {\n\t\tlistener.call(self,message);\n\t});\n}\n\nJocGame.prototype.HumanMove = function(move) {\n\tthis.DispatchMessage({\n\t\ttype: \"human-move\",\n\t\tmove: move\n\t});\n}\n\nJocGame.prototype.MachineMove = function(result) {\n\tthis.DispatchMessage({\n\t\ttype: \"machine-move\",\n\t\tresult: result\n\t});\n}\n\nJocGame.prototype.MachineProgress = function(progress) {\n\tthis.DispatchMessage({\n\t\ttype: \"machine-progress\",\n\t\tprogress: progress\n\t});\n}\n\nJocGame.prototype.PlayMove = function(move) {\n\tvar self = this;\n\tvar promise = new Promise(function(resolve,reject) {\n\t\tself.mOldBoard=new (self.GetBoardClass())(self);\n\t\tself.mOldBoard.CopyFrom(self.mBoard);\n\t\tself.ApplyMove(move);\n\t\tvar moveShown = self.mBoard.PlayedMove(self,move);\n\t\tif(moveShown)\n\t\t\tresolve();\n\t\telse\n\t\t\tself.MoveShown = function() {\n\t\t\t\tdelete self.MoveShown;\n\t\t\t\tresolve();\n\t\t\t}\n\t});\n\treturn promise;\n}\n\nJocGame.prototype.InvertWho = function() {\n\tvar who = this.GetWho();\n\tthis.SetWho(-who);\n}\n\nJocGame.prototype.AttachElement = function (element, options) {\n\toptions = options || {};\n\tvar game = this;\n\tthis.widget = element;\n\tvar promise = new Promise(function(resolve, reject) {\n\t\tif (game.gamePreAttachProto)\n\t\t\treject(new Error(\"Game already attached\"));\n\t\telse {\n\t\t\tvar systemJSConfig = {\n\t\t\t\tmeta: {\n\t\t\t\t\t\"jocly-xdview.js\": {\n\t\t\t\t\t\tglobals: {\n\t\t\t\t\t\t\tjQuery: \"jquery.js\",\n\t\t\t\t\t\t\tTHREE: \"three.js\"\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tsystemJSConfig.meta[\"games/\" + game.module + \"/\" + game.name + \"-view.js\"] = {\n\t\t\t\tglobals: {\n\t\t\t\t\txdview: \"jocly-xdview.js\",\n\t\t\t\t\tjQuery: \"jquery.js\",\n\t\t\t\t\tTHREE: \"three.js\"\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\tSystemJS.config(systemJSConfig);\n\n\t\tPromise.all([\n\t\t\tSystemJS.import(\"jocly-xdview.js\"),\n\t\t\tSystemJS.import(\"games/\" + game.module + \"/\" + game.name + \"-view.js\")\n\t\t]).then(function(args) {\n\t\t\tvar xdview = args[0], view = args[1];\n\t\t\tgame.gamePreAttachProto = Object.getPrototypeOf(game);\n\t\t\tvar gameProto = Object.assign({}, game.gamePreAttachProto, xdview.view.Game, view.view.Game);\n\t\t\tObject.setPrototypeOf(game, gameProto);\n\n\t\t\tvar Board = game.mBoardClass;\n\t\t\tgame.boardPreAttachProto = Board.prototype;\n\t\t\tObject.assign(Board.prototype, game.boardPreAttachProto, xdview.view.Board, view.view.Board);\n\n\t\t\tvar Move = game.mMoveClass;\n\t\t\tgame.movePreAttachProto = Move.prototype;\n\t\t\tObject.assign(Move.prototype, game.movePreAttachProto, view.view.Move);\n\n\t\t\tgame.mGeometry = {\n\t\t\t\twidth: game.widget.clientWidth,\n\t\t\t\theight: game.widget.clientHeight\n\t\t\t}\n\t\t\tgame.mWidget = jQuery(game.widget);\n\n\t\t\tgame.UpdateSounds();\n\t\t\tresolve();\n\t\t}, function(e) {\n\t\t\treject(e);\n\t\t});\n\t});\n\treturn promise;\n}\n\nJocGame.prototype.DetachElement = function () {\n\tvar game = this;\n\tthis.widget = element;\n\tvar promise = new Promise(function(resolve, reject) {\n\t\tif (!game.gamePreAttachProto)\n\t\t\treject(new Error(\"Game not attached\"));\n\t\telse {\n\t\t\t// TODO\n\t\t\tresolve();\n\t\t}\n\t});\n\treturn promise;\n}\n\nJocGame.prototype.GetBoardClass = function() {\n\treturn this.mBoardClass;\n}\n\nJocGame.prototype.GetMoveClass = function() {\n\treturn this.mMoveClass;\n}\n\nJocGame.prototype.CreateMove = function(args) {\n\treturn new this.mMoveClass(args);\n}\n\nJocGame.prototype.CloneBoard = function(board) {\n\tvar newBoard=new (this.GetBoardClass())(this);\n\tnewBoard.CopyFrom(board);\n\treturn newBoard;\n}\n\nJocGame.prototype.InitView = function() {\n\tconsole.log(\"Abstract InitView called\");\n}\n\nJocGame.prototype.GameInitView = function() {\n\tif(this.mGeometry.width>0 && this.mGeometry.height>0) {\n\t\tthis.InitView();\n\t\tthis.mViewInited=true;\n\t}\n}\n\nJocGame.prototype.DestroyView = function() {\n\tif(this.mWidget)\n\t\tthis.mWidget.empty();\n}\n\nJocGame.prototype.GameDestroyView = function() {\n\tif(this.mViewInited) {\n\t\tthis.DestroyView();\n\t\tthis.mViewInited=false;\n\t}\n}\n\nJocGame.prototype.CanPlaySound = function(tag) {\n\treturn true;\n}\n\nJocGame.prototype.UpdateSounds = function() {\n\tvar joclySounds = $(\"#jocly-sounds\");\n\tif(joclySounds.length==0)\n\t\tjoclySounds = $(\"<div/>\").attr(\"id\",\"jocly-sounds\").css({display:\"none\"}).appendTo($(\"body\"));\n\tfunction AddSound(tag, path, fname) {\n\t\tvar audio = $(\"<audio/>\").attr(\"id\", \"jocly-sound-\" + tag).attr(\"preload\",\"auto\");\n                $(\"<source/>\").attr(\"src\", path + \"/res/sounds/\" + fname + \".ogg\").attr(\"type\", \"audio/ogg\").appendTo(audio);\n\t\t$(\"<source/>\").attr(\"src\", path + \"/res/sounds/\" + fname + \".mp3\").attr(\"type\", \"audio/mp3\").appendTo(audio);\n\t\taudio.appendTo(joclySounds);\n\t}\n\tjoclySounds.empty();\n\tvar defaultSounds = {\n\t\tuseraction: \"bells1\",\n\t\tusermove: \"bells1\",\n\t\twin: \"winblues\",\n\t\tloss: \"lose\",\n\t\tend: \"draw\",\n\t}\n\tfor (var i in defaultSounds)\n\t\tAddSound(i, this.config.baseURL, defaultSounds[i]);\n\tif (this.config.view.sounds) {\n\t\tfor (var i in this.config.view.sounds) {\n\t\t\t$(\"#jocly-sound-\" + i).remove();\n\t\t\tif (this.config.view.sounds[i])\n\t\t\t\tif (this.config.view.sounds[i])\n\t\t\t\t\tAddSound(i, this.config.baseURL+\"games/\"+this.config.model.module, this.config.view.sounds[i]);\n\t\t}\n\t}\n}\n\nJocGame.prototype.PlaySound = function(tag) {\n\tif(!this.CanPlaySound(tag))\n\t\treturn;\n\tvar audio=document.getElementById(\"jocly-sound-\"+tag);\n\tif(audio && this.mSounds) {\n\t\tif(typeof this.mNeedPhonegapMedia==\"undefined\") {\n\t\t\tthis.mNeedPhonegapMedia=false;\n\t\t\tthis.mNeedPhonegapMedia = window && window.cordova && (typeof Media != \"undefined\");\n\t\t}\n\t\t\n\t\tif(this.mNeedPhonegapMedia) {\n\t\t\tif(typeof this.mPhonegapMediaLib==\"undefined\")\n\t\t\t\tthis.mPhonegapMediaLib={};\n\t\t\tif(typeof this.mPhonegapMediaLib[tag]==\"undefined\") {\n\t\t\t\tvar node=audio.firstChild;\n\t\t\t\twhile(node) {\n\t\t\t\t\tif(/source/i.test(node.nodeName) && node.getAttribute(\"type\")==\"audio/mp3\")\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tnode=node.nextSibling;\n\t\t\t\t}\n\t\t\t\tif(node) {\n\t\t\t\t\tvar src=node.getAttribute(\"src\");\n\t\t\t\t\t\n\t\t\t\t\tvar m=/^([^#\\?]*)\\/[^#\\?]+/.exec(window.location.pathname);\n\t\t\t\t\tif(m)\n\t\t\t\t\t\tsrc=src.replace(/^\\./,m[1]);\n\t\t\t\t\tsrc=src.replace(/%20/g,\" \");\n\t\t\t\t\tthis.mPhonegapMediaLib[tag]=new Media(src, function() {\n\t\t\t\t\t\t\t//console.info(\"PlaySound: Media played \"+src);\n\t\t\t\t\t\t},function(error) {\n\t\t\t\t\t\t\tconsole.warn(\"Jocly PlaySound: Media did not play \"+error.code);\n\t\t\t\t\t\t},function(status) {\n\t\t\t\t\t\t\t//console.info(\"PlaySound: mediaStatus \"+status);\n\t\t\t\t\t\t});\n\t\t\t\t} else\n\t\t\t\t\tthis.mPhonegapMediaLib[tag]=null;\n\t\t\t}\n\t\t\tif(this.mPhonegapMediaLib[tag]) {\n\t\t\t\tthis.mPhonegapMediaLib[tag].play();\n\t\t\t}\n\t\t} else\n\t\t\taudio.cloneNode(true).play();\n\t}\n}\n\nJocGame.prototype.InitGame = function() {\n}\n\nJocGame.prototype.GameInitGame = function() {\n\tif(this.mGameInited==false) {\n\t\tthis.mVisitedBoards={};\n\t\tif(arguments.length>0 && arguments[0])\n\t\t\tthis.mInitial=arguments[0];\n\t\telse\n\t\t\tthis.mInitial=null;\n\t\tthis.InitGame();\n\t\tthis.mGameInited=true;\n\t}\n}\n\nJocGame.prototype.DestroyGame = function() {\n}\n\nJocGame.prototype.GameDestroyGame = function() {\n\tif(this.mGameInited) {\n\t\tthis.DestroyGame();\n\t\tthis.mGameInited=false;\n\t}\n\tif(this.aiWorker) {\n\t\ttry {\n\t\t\tthis.aiWorker.terminate();\n\t\t\tdelete this.aiWorker;\n\t\t} catch(e) {\n\t\t\tconsole.warn(\"Cannot terminate worker\",e);\n\t\t}\n\t}\n}\n\nJocGame.prototype.DisplayBoard = function() {\n\tif(this.mBoard.Display)\n\t\tthis.mBoard.Display(this);\n}\n\nJocGame.prototype.SetWho = function(aWho) {\n\tthis.mWho = aWho;\n\tthis.mBoard.mWho = aWho;\n}\n\nJocGame.prototype.GetWho = function() {\n\treturn this.mWho;\n}\n\nJocGame.prototype.HumanTurn = function() {\n\tif(this.mBoard.mMoves.length==0) {\n\t\tthis.mCurrentLevel=-1; \n\t\tthis.mBoard.GenerateMoves(this);\n\t}\n\tthis.mBoard.HumanTurn(this);\n}\n\nJocGame.prototype.HumanTurnEnd = function() {\n\tthis.mBoard.HumanTurnEnd(this);\n}\n\nJocGame.prototype.PlayedMove = function(aMove, aOldBoard) {\n\tthis.mOldBoard=aOldBoard;\n\treturn this.mBoard.PlayedMove(this,aMove);\n}\n\nJocGame.prototype.ShowEnd = function() {\n\treturn this.mBoard.ShowEnd(this);\n}\n\nJocGame.prototype.EvaluateBoard = function() {\n\tthis.mBoard.mFinished=false;\n\tthis.mBoard.mMoves=[];\n\tthis.mCurrentLevel=-1;\n\tthis.mBoard.GenerateMoves(this);\n\tif(this.mBoard.mFinished==false)\n\t\tthis.mBoard.Evaluate(this,true,true);\n\t//JocLog(\"EvaluatedBoard \"+JSON.stringify(this.mBoard));\n}\n\nJocGame.prototype.GetFinished = function() {\n\tthis.SetWho(-this.mWho);\n\tvar moves=this.mBoard.mMoves;\n\tthis.EvaluateBoard();\n\tthis.mBoard.mMoves=moves;\n\tthis.SetWho(-this.mWho);\n\tif(this.mBoard.mFinished)\n\t\treturn this.mBoard.mWinner;\n\telse\n\t\treturn 0;\n}\n\nJocGame.prototype.IsValidMove = function(args) {\n\tvar move = new (this.GetMoveClass())(args);\n\treturn this.mBoard.IsValidMove(this,move);\n}\n\nJocGame.prototype.AddVisit = function(board,sign) {\n\tif(board)\n\t\tsign=board.GetSignature();\n\tvar visits=this.mVisitedBoards[sign];\n\tif(visits===undefined)\n\t\tthis.mVisitedBoards[sign]=1;\n\telse\n\t\tthis.mVisitedBoards[sign]++;\n}\n\nJocGame.prototype.RemoveVisit = function(board,sign) {\n\tif(board)\n\t\tsign=board.GetSignature();\n\tvar visits=this.mVisitedBoards[sign];\n\tif(visits!==undefined) {\n\t\tif(visits>1)\n\t\t\tthis.mVisitedBoards[sign]--;\n\t\telse\n\t\t\tdelete this.mVisitedBoards[sign];\n\t}\n}\n\nvar engdbg_loops, engdbg_time, engdbg_t0;\n\nJocGame.prototype.StartMachine = function(aOptions) {\n\tengdbg_loops=0;\n\tengdbg_time=0;\n\tengdbg_t0=Date.now();\n\t\n\tthis.mDoneCallback=aOptions.Done || this.MachineMove;\n\tthis.mProgressCallback=aOptions.Progress || this.MachineProgress;\n\tif(typeof(aOptions.level)!=\"undefined\")\n\t\tthis.mTopLevel=aOptions.level;\n\tif(typeof(aOptions.maxDepth)!=\"undefined\")\n\t\tthis.mTopLevel=aOptions.maxDepth;\n\tthis.mStartTime = new Date().getTime();\n\tthis.mExploredCount = 0;\n\tthis.mPickedMoveIndex = 0;\n\tthis.mBestMoves = [];\n\tthis.mContexts = [];\n\tthis.mDuration = 0;\n\tthis.mAborted = false;\n\tthis.mRandomSeed = 0;\n\tif(aOptions.randomSeed && !isNaN(parseInt(aOptions.randomSeed)))\n\t\tthis.mRandomSeed = parseInt(aOptions.randomSeed);\n\tif(typeof this.mBoard.StaticGenerateMoves ==\"function\") {\n\t\tvar moves=this.mBoard.StaticGenerateMoves(this);\n\t\tif(moves && moves.length>0) {\n\t\t\tthis.mBestMoves=moves;\n\t\t\tJocUtil.schedule(this, \"Done\", {});\n\t\t\treturn;\n\t\t}\n\t}\n\t\n\tif(this.mOptions.levelOptions) {\n\t\tthis.mOptions.levelOptionsSaved=JSON.parse(JSON.stringify(this.mOptions.levelOptions));\n\t\tif(aOptions.level)\n\t\t\tObject.assign(this.mOptions.levelOptions,aOptions.level);\n\t}\n\t\n\tvar aiThread = aOptions.threaded && typeof window==\"object\" && window.Worker;\n\tif(aOptions.level && aOptions.level.ai==\"uct\" && JoclyUCT) {\n\t\tif(aiThread)\n\t\t\tthis.StartThreadedMachine(aOptions,\"uct\");\n\t\telse\n\t\t\tJoclyUCT.startMachine(this,aOptions);\n\t}\n\telse { // default is legacy alpha-beta ai\n\t\tif(aiThread)\n\t\t\tthis.StartThreadedMachine(aOptions,\"alpha-beta\");\n\t\telse {\n\t\t\tthis.mSavedVisitedBoards={}\n\t\t\tfor(var s in this.mVisitedBoards)\n\t\t\t\tthis.mSavedVisitedBoards[s]=this.mVisitedBoards[s];\n\t\t\tthis.Engine(this.mBoard, this.mTopLevel, false, 0, aOptions.potential); // start algo\n\t\t\tthis.Run();\n\t\t}\n\t}\n}\n\nJocGame.prototype.StartThreadedMachine = function(aOptions,algo) {\n\tvar $this = this;\n\tdelete aOptions.Done;\n\tdelete aOptions.Progress;\n\tvar t0 = Date.now();\n\tif(!this.aiWorker) {\n\t\tthis.aiWorker = new Worker(this.config.baseURL+'jocly.aiworker.js');\n\t\tthis.aiWorker.postMessage({\n\t\t\ttype: \"Init\",\n\t\t\tbaseURL: this.config.baseURL,\n\t\t\t//modelURL: this.config.baseURL+\"games/\"+this.config.model.module+\"/\"+this.name+\"-model.js\",\n\t\t\toptions: aOptions,\n\t\t\tt0: t0\n\t\t});\n\t}\n\tthis.aiWorker.onmessage = function(e) {\n\t\tvar message = e.data;\n\t\tswitch(message.type) {\n\t\t\tcase \"Progress\":\n\t\t\t\t$this.mProgressCallback(message.percent);\n\t\t\t\tbreak;\n\t\t\tcase \"Done\":\n\t\t\t\t$this.mBestMoves = message.data.moves;\n\t\t\t\t$this.mPickedMoveIndex = message.data.moveIndex;\n\t\t\t\t$this.mExploredCount = message.data.explored;\n\t\t\t\t$this.mDuration = message.data.duration;\n\t\t\t\t$this.mBoard.evaluation = message.data.evaluation;\n\t\t\t\t$this.Done();\n\t\t\t\tbreak;\n\t\t}\n\t}\n\tthis.aiWorker.postMessage({\n\t\ttype: \"Play\",\n\t\tplayedMoves: this.mPlayedMoves,\n\t\tgameOptions: this.mOptions,\n\t\tgameName: this.name,\n\t\toptions: aOptions,\n\t\talgo: algo,\n\t\tt0: t0\n\t});\n}\n\nJocGame.prototype.ScheduleStep = function() {\n\tthis.mNextSchedule = this.ExecuteStep;\n}\n\nJocGame.prototype.Random = function(roof) {\n\tvar value;\n\tif(this.mRandomSeed)\n\t\tvalue = this.mRandomSeed % roof; \n\telse\n\t\tvalue = Math.floor(Math.random()*roof);\n\treturn value;\n}\n\nJocGame.prototype.ArrayShuffle = function(arr) {\n\tvar i = arr.length;\n\tif (i<=0) return;\n\twhile (--i) {\n\t\tvar j;\n\t\tif(this.mRandomSeed)\n\t\t\tj=this.mRandomSeed%(i+1);\n\t\telse\n\t\t\tj=Math.floor(Math.random()*(i+1));\n\t\tvar tmp = arr[i];\n\t\tarr[i] = arr[j];\n\t\tarr[j] = tmp;\n\t}\n}\n\nJocGame.prototype.Done = function() {\n\tthis.mDuration = new Date().getTime() - this.mStartTime;\n\tif(this.mOptions.levelOptionsSaved) {\n\t\tthis.mOptions.levelOptions=this.mOptions.levelOptionsSaved;\n\t\tthis.mOptions.levelOptionsSaved=null;\n\t}\n\tif(this.mSavedVisitedBoards)\n\t\tthis.mVisitedBoards=this.mSavedVisitedBoards;\n\tif (this.mDoneCallback) {\n\t\tthis.mPickedMoveIndex = this.Random(this.mBestMoves.length);\n\t\ttry {\n\t\t\tif(this.mProgressCallback) {\n\t\t\t\tthis.mProgressCallback(100);\n\t\t\t}\n\t\t\tthis.mDoneCallback( {\n\t\t\t\tmoves : this.mBestMoves,\n\t\t\t\tmove : this.mBestMoves[this.mPickedMoveIndex],\n\t\t\t\tmoveIndex : this.mPickedMoveIndex,\n\t\t\t\texplored : this.mExploredCount,\n\t\t\t\tduration : this.mDuration,\n\t\t\t\tevaluation : this.mBoard.mEvaluation\n\t\t\t});\n\t\t} catch (e) {\n\t\t\tJocLog(\"!!! Done:\" + e,e.stack?e.stack:\"\");\n\t\t}\n\t}\n}\n\nJocGame.prototype.Run = function() {\n\tvar t0=Date.now();\n\ttry {\n\t\tvar tNow = new Date().getTime();\n\t\twhile (this.mNextSchedule && new Date().getTime()-tNow<20 && this.mAborted==false) {\n\t\t\tvar fnt = this.mNextSchedule;\n\t\t\tthis.mNextSchedule = null;\n\t\t\tfnt.call(this);\n\t\t}\n\t\tif(this.mAborted) {\n\t\t\tthis.mAbortCallback();\n\t\t} else if (this.mNextSchedule) {\n\t\t\tJocUtil.schedule(this, \"Run\", {});\n\t\t}\n\t} catch(e) { \n\t\tJocLog(\"JocGame.Run \"+e+\"\\n\"+e.stack);\n\t}\n\tvar t1=Date.now();\n\tengdbg_loops++;\n\tengdbg_time+=t1-t0;\n}\n\nJocGame.prototype.Abort = function(aAbortCallback) {\n\tvar $this=this;\n\tthis.mAbortCallback=function() {\n\t\tif($this.mOptions.levelOptionsSaved) {\n\t\t\t$this.mOptions.levelOptions=$this.mOptions.levelOptionsSaved;\n\t\t\t$this.mOptions.levelOptionsSaved=null;\n\t\t}\n\t\tif($this.mSavedVisitedBoards) {\n\t\t\t$this.mVisitedBoards=$this.mSavedVisitedBoards;\n\t\t\t$this.mSavedVisitedBoards=null;\n\t\t}\n\t\taAbortCallback();\n\t}\n\tthis.mAborted=true;\n}\n\nJocGame.prototype.Engine = function(aBoard, aLevel, aBAlpha, aAlpha, aPotential) {\n\tvar context = {\n\t\tmBoard : aBoard,\n\t\tmLevel : aLevel,\n\t\tmBAlpha : aBAlpha,\n\t\tmAlpha : aAlpha,\n\t\tmBestEvaluation : 0,\n\t\tmMoveIndex : 0,\n\t\tmNextBoard : null,\n\t\tmNextBoards : null\n\t}\n\tthis.mContexts.push(context);\n\n\tcontext.mBoard.mFinished = false;\n\tcontext.mBoard.mWinner = JocGame.DRAW;\n\tthis.mCurrentLevel=aLevel; \n\tif(context.mBoard.mMoves.length==0)\n\t\tcontext.mBoard.GenerateMoves(this);\n\n\t//JocLog(\"Level \"+aLevel+\" \"+context.mBoard.mMoves.length+\" moves\");\n\tif (context.mBoard.mMoves.length == 0 && context.mBoard.mFinished == false) {\n\t\tcontext.mBoard.Evaluate(this,true,false);\n\t\tif(context.mBoard.mFinished == false) {\n\t\t\tJocLog(\"!!! No move possible while not finished - player\",this.mWho,\"board\",context.mBoard);\n\t\t\tcontext.mBoard.mFinished=true;\n\t\t}\n\t}\n\t\t\n\t//JocLog(\"No possible move level \"+aLevel+\" from \"+JSON.stringify(context.mBoard));\n\tif(context.mBoard.mFinished) {\n\t\tswitch (context.mBoard.mWinner) {\n\t\tcase JocGame.PLAYER_A:\n\t\t\tcontext.mBoard.mEvaluation = JocGame.MAX_VALUE - (this.mTopLevel - context.mLevel);\n\t\t\tbreak;\n\t\tcase JocGame.PLAYER_B:\n\t\t\tcontext.mBoard.mEvaluation = -JocGame.MAX_VALUE + (this.mTopLevel - context.mLevel);\n\t\t\tbreak;\n\t\t}\n\t\tcontext.mBestEvaluation = context.mBoard.mEvaluation;\n\t\tthis.ExecuteStep2();\n\t\treturn;\n\t}\n\n\tcontext.mExploCtrl={\n\t\texploFrom: this.mExploredCount,\n\t\texploTo: this.mExploredCount+aPotential,\n\t}\n\t\n\tif(context.mBoard.QuickEvaluate) {\n\t\tvar boardsMoves=[];\n\t\tfor(var i in context.mBoard.mMoves) {\n\t\t\tvar board=context.mBoard.MakeAndApply(this,i);\n\t\t\tvar quickEval=board.QuickEvaluate(this);\n\t\t\tboardsMoves.push({\n\t\t\t\tmove: context.mBoard.mMoves[i],\n\t\t\t\tboard: board,\n\t\t\t\tevaluation: quickEval\n\t\t\t});\n\t\t}\n\t\tfunction MoveSort(bm1,bm2) {\n\t\t\treturn (bm2.evaluation-bm1.evaluation)*context.mBoard.mWho;\n\t\t}\n\t\tboardsMoves.sort(MoveSort);\n\t\tcontext.mBoard.mMoves=[];\n\t\tcontext.mNextBoards=[];\n\t\tif(typeof this.mOptions.capMoves != \"undefined\")\n\t\t\tboardsMoves=boardsMoves.slice(0,this.mOptions.capMoves);\n\t\tfor(var i in boardsMoves) {\n\t\t\tcontext.mBoard.mMoves.push(boardsMoves[i].move);\n\t\t\tcontext.mNextBoards.push(boardsMoves[i].board);\n\t\t}\n\t}\n\tthis.ExecuteStep();\n}\n\nJocGame.prototype.ExecuteStep = function() {\n\tthis.mExploredCount++;\n\t// JocLog(\"# context: \"+this.mContexts.length);\n\tvar context = this.mContexts[this.mContexts.length - 1];\n\t//JocLog(\"ExecuteStep level \"+context.mLevel+\" index \"+context.mMoveIndex+\"/\"+context.mBoard.mMoves.length);\n\tif(context.mNextBoards) {\n\t\tcontext.mNextBoard = context.mNextBoards[context.mMoveIndex];\n\t} else {\n\t\tcontext.mNextBoard = context.mBoard.MakeAndApply(this,context.mMoveIndex);\n\t}\n\n\tif(this.mProgressCallback) {\n\t\tvar percent=null;\n\t\tif(context.mLevel==this.mTopLevel)\n\t\t\tpercent=Math.floor((context.mMoveIndex*100)/context.mBoard.mMoves.length);\n\t\telse if(context.mLevel==this.mTopLevel-1) {\n\t\t\tvar topContext=this.mContexts[0];\n\t\t\tvar topStep=1/topContext.mBoard.mMoves.length;\n\t\t\tpercent=Math.floor(100*(topContext.mMoveIndex*topStep+(context.mMoveIndex*topStep/context.mBoard.mMoves.length)));\n\t\t}\n\t\tif(percent!=null) \n\t\t\ttry {\n\t\t\t\tthis.mProgressCallback(percent);\n\t\t\t} catch(e) {}\n\t}\n\n\tvar nextBoard = context.mNextBoard;\n\tnextBoard.mFinished = false;\n\tnextBoard.mWinner = 0;\n\tnextBoard.Evaluate(this,context.mLevel==0,false,this);\n\t\n\tif(context.mLevel<0) // random mode\n\t\tnextBoard.mEvaluation=0;\n\t\n\t// JocLog(\"Eval2 \"+nextBoard.mFinished+\"/\"+nextBoard.mWinner+\"/\"+nextBoard.mEvaluation);\n\tif (nextBoard.mFinished) {\n\t\tswitch (nextBoard.mWinner) {\n\t\tcase JocGame.PLAYER_A:\n\t\t\tnextBoard.mEvaluation = JocGame.MAX_VALUE - (this.mTopLevel - context.mLevel);\n\t\t\tbreak;\n\t\tcase JocGame.PLAYER_B:\n\t\t\tnextBoard.mEvaluation = -JocGame.MAX_VALUE + (this.mTopLevel - context.mLevel);\n\t\t\tbreak;\n\t\tcase JocGame.DRAW:\n\t\t\tnextBoard.mEvaluation = 0;\n\t\t\tbreak;\n\t\t}\n\t} else if(context.mLevel==this.mTopLevel && context.mBoard.mMoves.length==1) {\n\t\t// one possible move at top level: no need to recurse\n\t} else if (context.mLevel > 0) {\n\t\tvar potential=(context.mExploCtrl.exploTo-this.mExploredCount)/context.mBoard.mMoves.length;\n\t\t//JocLog(\"ExecuteStep\",potential,context.mLevel,context.mExploCtrl);\n\t\tif(potential>=1) { \n\t\t\tnextBoard.mWho = -nextBoard.mWho; // player changes\n\t\t\tthis.Engine(nextBoard, context.mLevel - 1, (context.mMoveIndex != 0),\n\t\t\t\t\tcontext.mBestEvaluation,potential); // recurse algo\n\t\t\treturn;\n\t\t}\n\t}\n\tthis.ExecuteStep2();\n}\n\nJocGame.prototype.ExecuteStep2 = function() {\n\tvar context = this.mContexts[this.mContexts.length - 1];\n\t//JocLog(\"ExecuteStep2 level \"+context.mLevel+\" index \"+context.mMoveIndex+\" \"+JSON.stringify(context.mBoard.board));\n\tif(context.mBoard.mMoves.length>0) {\n\t\tif (context.mMoveIndex == 0) { // first evaluated move\n\t\t\tcontext.mBestEvaluation = context.mNextBoard.mEvaluation; // then it's the best one so far\n\t\t\tif (context.mLevel == this.mTopLevel) // if top level\n\t\t\t\tthis.SetBest(context.mBoard.mMoves[0], context.mBoard); // store move\n\t\t} else { // another move evaluated\n\t\t\tif (context.mNextBoard.mWho > 0) { // B plays\n\t\t\t\tif (context.mNextBoard.mEvaluation > context.mBestEvaluation) { // best move ?\n\t\t\t\t\tcontext.mBestEvaluation = context.mNextBoard.mEvaluation; // remember it\n\t\t\t\t\tif (context.mLevel == this.mTopLevel) // if top level\n\t\t\t\t\t\tthis.SetBest(context.mBoard.mMoves[context.mMoveIndex],\n\t\t\t\t\t\t\t\tcontext.mBoard); // then store\n\t\t\t\t} else if (context.mLevel == this.mTopLevel\n\t\t\t\t\t\t&& context.mNextBoard.mEvaluation == context.mBestEvaluation) { // top level and\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// another best\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// move\n\t\t\t\t\tthis.AddBest(context.mBoard.mMoves[context.mMoveIndex],\n\t\t\t\t\t\t\tcontext.mBoard); // add to best moves\n\t\t\t\t}\n\t\t\t} else { // A plays\n\t\t\t\tif (context.mNextBoard.mEvaluation < context.mBestEvaluation) { // best move\n\t\t\t\t\tcontext.mBestEvaluation = context.mNextBoard.mEvaluation; // keep it\n\t\t\t\t\tif (context.mLevel == this.mTopLevel)\n\t\t\t\t\t\tthis.SetBest(context.mBoard.mMoves[context.mMoveIndex],\n\t\t\t\t\t\t\t\tcontext.mBoard);\n\t\t\t\t} else if (context.mLevel == this.mTopLevel\n\t\t\t\t\t\t&& context.mNextBoard.mEvaluation == context.mBestEvaluation)\n\t\t\t\t\tthis.AddBest(context.mBoard.mMoves[context.mMoveIndex],\n\t\t\t\t\t\t\tcontext.mBoard);\n\t\t\t}\n\t\t}\n\t}\n\tcontext.mBoard.mEvaluation = context.mBestEvaluation; // assign best eval\n\tif (context.mBAlpha) { // alpha-beta pruning\n\t\tif ((context.mBoard.mWho == JocGame.PLAYER_A && context.mBestEvaluation > context.mAlpha)\n\t\t\t\t|| (context.mBoard.mWho == JocGame.PLAYER_B && context.mBestEvaluation < context.mAlpha)) {\n\t\t\tcontext.mMoveIndex = context.mBoard.mMoves.length - 1; \n\t\t\t//JocLog(\"Alpha-beta pruned level\");\n\t\t\t// ensure no more looking for other moves at this level\n\t\t}\n\t}\n\n\tcontext.mMoveIndex++;\n\tif (context.mMoveIndex < context.mBoard.mMoves.length) {\n\t\tthis.ScheduleStep();\n\t} else {\n\t\t//JocLog(\"BestEval level \"+context.mLevel+\": \"+context.mBestEvaluation+\" \"+context.mMoveIndex+\"/\"+context.mBoard.mMoves.length);\n\t\tthis.mContexts.pop();\n\t\tif (this.mContexts.length > 0) {\n\t\t\tvar context = this.mContexts[this.mContexts.length - 1];\n\t\t\tcontext.mNextBoard.mWho = -context.mNextBoard.mWho;\n\t\t\tthis.ExecuteStep2();\n\t\t} else {\n\t\t\tdelete context.mBoard.mMoves;\n\t\t\t//JocLog(\"Best eval \"+context.mBestEvaluation);\n\t\t\tthis.Done();\n\t\t}\n\t}\n}\n\nJocGame.prototype.SetBest = function(aMove, aBoard) {\n\tvar move = new (this.GetMoveClass())({});\n\tmove.CopyFrom(aMove);\n\tthis.mBestMoves = [ move ];\n}\n\nJocGame.prototype.AddBest = function(aMove, aBoard) {\n\tvar move = new (this.GetMoveClass())({});\n\tmove.CopyFrom(aMove);\n\tthis.mBestMoves.push(move);\n}\n\nJocGame.prototype.GetRepeatOccurence = function(board) {\n\tif(!this.mOptions.preventRepeat)\n\t\treturn -1;\n\tvar repOcc=this.mVisitedBoards[board.GetSignature()];\n\treturn repOcc;\n}\n\nJocGame.prototype.HandleRepeat = function(board) {\n\tif(this.mOptions.preventRepeat) {\n\t\tvar sign=board.GetSignature(true);\n\t\tif(this.mVisitedBoards[sign]===undefined)\n\t\t\tthis.mVisitedBoards[sign]=1;\n\t\telse\n\t\t\tthis.mVisitedBoards[sign]++;\n\t}\n}\n\nJocGame.prototype.UnhandleRepeat = function(board) {\n\tif(this.mOptions.preventRepeat) {\n\t\tvar sign=board.GetSignature(true);\n\t\tif(this.mVisitedBoards[sign]==1)\n\t\t\tdelete this.mVisitedBoards[sign];\n\t\telse if(this.mVisitedBoards[sign]>1)\n\t\t\tthis.mVisitedBoards[sign]--;\n\t}\n}\n\nJocGame.prototype.ApplyMove = function(aMove) {\n\tvar move = new (this.GetMoveClass())({});\n\tmove.CopyFrom(aMove);\n\tthis.mPlayedMoves.push(move);\n\tif(this.mFullPlayedMoves.length<this.mPlayedMoves.length)\n\t\tthis.mFullPlayedMoves.push(move);\n\telse if(!move.Equals(this.mFullPlayedMoves[this.mPlayedMoves.length-1])) {\n\t\tthis.mFullPlayedMoves=this.mFullPlayedMoves.slice(0,this.mPlayedMoves.length-1);\n\t\tthis.mFullPlayedMoves.push(move);\n\t}\n\tthis.mBoard.ApplyMove(this,aMove);\n\tthis.mBoard.mMoves=[];\n\tthis.HandleRepeat(this.mBoard);\n}\n\nJocGame.prototype.BackTo = function(aIndex,moves) {\n\tif(!moves)\n\t\tmoves=this.mFullPlayedMoves;\n\tthis.mWho = JocGame.PLAYER_A;\n\tthis.mBoard = new (this.GetBoardClass())(this);\n\tif(this.mBoard.InitialPosition)\n\t\tthis.mBoard.InitialPosition(this);\n\tif(this.mInitial && this.mInitial.turn)\n\t\tthis.mWho = this.mInitial.turn;\n\tthis.mBoard.mWho = this.mWho;\n\tthis.mBestMoves = [];\n\tthis.mVisitedBoards={};\n\tthis.mPlayedMoves = [];\n\tfor(var i=0;i<aIndex;i++) {\n\t\tthis.mBoard.ApplyMove(this,moves[i]);\n\t\tthis.HandleRepeat(this.mBoard);\n\t\tthis.mBoard.mWho=-this.mBoard.mWho;\n\t\tthis.mPlayedMoves.push(moves[i]);\n\t}\n\tthis.mWho=this.mBoard.mWho;\n}\n\nJocGame.prototype.Load = function(gameData) {\n\tthis.mWho = JocGame.PLAYER_A;\n\tthis.mBoard = new (this.GetBoardClass())(this);\n\tif(this.mBoard.InitialPosition)\n\t\tthis.mBoard.InitialPosition(this);\n\tthis.mBoard.mWho = this.mWho;\n\tvar board = this.GetBoardClass();\n\tif(gameData.initialBoard)\n\t\tboard.CopyFrom(gameData.initialBoard);\n\tthis.mBestMoves = [];\n\tthis.mVisitedBoards={};\n\tvar moves=gameData.playedMoves;\n\tthis.mPlayedMoves = [];\n\tthis.mFullPlayedMoves = [];\n\tfor(var i in moves) {\n\t\tvar move=new (this.GetMoveClass())(moves[i]);\n\t\tif(!this.IsValidMove(move))\n\t\t\tthrow \"invalid-move\";\t\t\n\t\tthis.mBoard.ApplyMove(this,move);\n\t\tthis.HandleRepeat(this.mBoard);\n\t\tthis.mBoard.mWho=-this.mBoard.mWho;\n\t\tthis.mPlayedMoves.push(move);\n\t\tthis.mFullPlayedMoves.push(move);\n\t\tthis.mBoard.mMoves=[];\n\t}\n\tthis.mWho=this.mBoard.mWho;\n\tif(this.mBoard.mFinished==false)\n\t\tthis.mBoard.Evaluate(this,true,true);\n}\n\nJocGame.prototype.CloseView = function() {\n}\n\nJocMove.prototype = {}\n\nJocMove.prototype.CopyFrom = function(aMove) {\n\tvar fields=JSON.parse(JSON.stringify(aMove));\n\tfor(var f in fields) {\n\t\tthis[f]=fields[f];\n\t}\n}\n\nJocMove.prototype.Equals = function(move) {\n\treturn JSON.stringify(this)==JSON.stringify(move);\n}\n\nJocMove.prototype.ToString = function() {\n\treturn JSON.stringify(this);\n}\n\nJocMove.prototype.Strip = function() {\n\treturn this;\n}\n\nJocBoard.prototype = {}\n\nJocBoard.prototype.Init = function(aGame) {\n}\n\nJocBoard.prototype.InitBoard = function(aGame) {\n\tthis.mDepth = 0; // no depth calc\n\tthis.mMoves = []; // move storage\n\tthis.mEvaluation = 0; // not evaluated yet\n\tthis.mFinished = false;\n\tthis.mWinner = 0;\n\tthis.Init(aGame);\n}\n\nJocBoard.prototype.CopyFrom = function(aBoard) {\n\tvar signature=aBoard.mSignature;\n\tdelete(aBoard.mSignature);\n\tvar fields=JSON.parse(JSON.stringify(aBoard));\n\tfor(var f in fields) {\n\t\tthis[f]=fields[f];\n\t}\n\taBoard.mSignature=signature;\n}\n\nJocBoard.prototype.GetSignature = function() {\n\tif(arguments[0] || !this.mSignature) {\n\t\tvar moves=this.mMoves;\n\t\tdelete(this.mMoves);\n\t\tdelete(this.mSignature);\n\t\tthis.mSignature=JocUtil.md5(JSON.stringify(this));\n\t\t//JocLog(\"signature\",this.mSignature,this);\n\t\tthis.mMoves=moves;\n\t}\n\treturn this.mSignature;\n}\n\nJocBoard.prototype.ApplyMove = function(aGame,aMove) {\n\tJocLog(\"Method JocBoard:ApplyMove() must be overloaded\");\n\t// must be overloaded\n}\n\nJocBoard.prototype.GenerateMoves = function(aGame) {\n\tJocLog(\"Method JocBoard:GenerateMoves() must be overloaded\");\n\t// must be overloaded\n}\n\nJocBoard.prototype.Evaluate = function(aGame,aFinishOnly,aTopLevel) {\n\tJocLog(\"Method JocBoard:Evaluate() must be overloaded\");\n\tthis.mEvaluation = 0; // must be overloaded\n}\n\nJocBoard.prototype.HumanTurn = function() {\n}\n\nJocBoard.prototype.HumanTurnEnd = function() {\n}\n\nJocBoard.prototype.PlayedMove = function() {\n}\n\nJocBoard.prototype.ShowEnd = function() {\n}\n\nJocBoard.prototype.MakeAndApply = function(aGame,aIndex) {\n\tvar board = new (aGame.GetBoardClass())(aGame);\t\n\tboard.CopyFrom(this);\n\tboard.mWho = this.mWho;\n\tboard.mBoardClass = this.mBoardClass;\n\tboard.ApplyMove(aGame,this.mMoves[aIndex]); // apply move\n\tboard.mMoves=[];\n\treturn board;\n}\n\nJocBoard.prototype.IsValidMove = function(aGame,move) {\n\tif(typeof move.Equals != \"function\")\n\t\tmove=aGame.CreateMove(move);\n\tif(!this.mMoves || this.mMoves.length==0) {\n\t\tthis.mCurrentLevel=-1;\n\t\tthis.GenerateMoves(aGame);\n\t}\n\tfor(var i in this.mMoves) {\n\t\tif(move.Equals(this.mMoves[i]))\n\t\t\treturn true;\n\t}\n\tconsole.error(\"Invalid move \"+JSON.stringify(move)+\" in \"+JSON.stringify(this.mMoves));\n\treturn false;\n}\n\nJocBoard.prototype.PushMove = function(aGame,args) {\n\tthis.mMoves.push(aGame.CreateMove(args));\n}\n\n\nJocBoard.prototype.GenerateMoveObjects = function(aGame) {\n\tvar moves=[];\n\tthis.mMoves=[];\n\tthis.GenerateMoves(aGame);\n\tfor(var i=0;i<this.mMoves.length;i++)\n\t\tmoves.push(aGame.CreateMove(this.mMoves[i]));\n\tthis.mMoves=moves;\n}\n\nJocBoard.prototype.ExportBoardState = function(aGame) {\n\treturn JSON.stringify(this);\n}\n\nJocGame.prototype.GetBestMatchingMove = function(moveStr,candidateMoves) {\n\tvar prettyMoves=[];\n\tvar $this=this;\n\tcandidateMoves.forEach(function(m) {\n\t\tif(typeof m.ToString==\"function\")\n\t\t\tprettyMoves.push(m.ToString());\n\t\telse\n\t\t\tprettyMoves.push($this.CreateMove(m).ToString());\n\t});\n\tvar bestDist=Infinity;\n\tvar bestMatches=[];\n\tcandidateMoves.forEach(function(candidate,index) {\n\t\tvar dist=JocGame.Levenshtein(moveStr,prettyMoves[index])/(Math.max(prettyMoves[index].length,moveStr.length)+1);\n\t\tif(dist==bestDist)\n\t\t\tbestMatches.push(index);\n\t\telse if(dist<bestDist) {\n\t\t\tbestMatches=[index];\n\t\t\tbestDist=dist;\n\t\t}\n\t});\n\tif(bestMatches.length==1)\n\t\treturn candidateMoves[bestMatches[0]];\n\n\tvar candidateIndexes=bestMatches;\n\tvar matches=[];\n\tcandidateIndexes.forEach(function(index) {\n\t\tvar pretty=prettyMoves[index];\n\t\tif(moveStr.indexOf(pretty)>=0 || pretty.indexOf(moveStr)>=0)\n\t\t\tmatches.push(index);\n\t});\n\tif(matches.length==1)\n\t\treturn candidateMoves[matches[0]];\n\n\tbestDist=Infinity;\n\tbestMatches=[];\n\tcandidateIndexes.forEach(function(index) {\n\t\tvar dist=0;\n\t\tvar str1=moveStr.replace(/[A-Z]/g,'');\n\t\tvar str2=prettyMoves[index].replace(/[A-Z]/g,'');\n\t\tdist+=JocGame.Levenshtein(str1,str2)/(Math.max(str1.length,str2.length)+1);\n\t\tdist+=(str1.indexOf(str2)>=0 || str2.indexOf(str1)>=0)?0:1;\n\t\tstr1=moveStr.replace(/[a-z]/g,'');\n\t\tstr2=prettyMoves[index].replace(/[a-z]/g,'');\n\t\tdist+=JocGame.Levenshtein(str1,str2).distance/(Math.max(str1.length,str2.length)+1);\n\t\tdist+=(str1.indexOf(str2)>=0 || str2.indexOf(str1)>=0)?0:1;\n\t\tif(dist==bestDist)\n\t\t\tbestMatches.push(index);\n\t\telse if(dist<bestDist) {\n\t\t\tbestMatches=[index];\n\t\t\tbestDist=dist;\n\t\t}\n\t});\n\tif(bestMatches.length==1)\n\t\treturn candidateMoves[bestMatches[0]];\n\treturn null;\n}\n\nJocBoard.prototype.PickMoveFromDatabase = function(aGame,database) {\n\tif(!this.mMoves || this.mMoves.length==0) {\n\t\tvar moves=[];\n\t\tthis.mMoves=[];\n\t\tthis.GenerateMoves(aGame);\n\t\tfor(var i=0;i<this.mMoves.length;i++)\n\t\t\tmoves.push(aGame.CreateMove(this.mMoves[i]));\n\t\tthis.mMoves=moves;\n\t}\n\tif(this.mMoves.length==0)\n\t\treturn null;\n\tvar key=\"\"+this.mWho+\"#\"+this.GetSignature();\n\tvar dbMoves=database[key];\n\tif(!dbMoves)\n\t\treturn null;\n\tvar totalEval=0;\n\tfor(var i=0;i<dbMoves.length;i++)\n\t\ttotalEval+=dbMoves[i].e;\n\tvar rnd=Math.random()*totalEval;\n\tvar current=0;\n\tfor(var i=0;i<dbMoves.length;i++) {\n\t\tvar dbMove=dbMoves[i];\n\t\tcurrent+=dbMove.e;\n\t\tif(current>rnd) {\n\t\t\tvar pickedMove=aGame.GetBestMatchingMove(dbMove.m,this.mMoves);\n\t\t\tif(pickedMove)\n\t\t\t\treturn [pickedMove];\n\t\t}\n\t}\n\treturn null; // never reached\n}\n\nJocBoard.prototype.CompactMoveString = function(aGame,aMove) {\n\tif(typeof aMove.ToString!=\"function\")\n\t\taMove=aGame.CreateMove(aMove);\n\treturn aMove.ToString();\n}\n\n/*-- Zobrist implementation --*/\n\nJocGame.Zobrist=function(params) {\n\tvar mt=new MersenneTwister(12345);\n\tvar paramNames=[];\n\tfor(var f in params)\n\t\tparamNames.push(f);\n\tparamNames.sort(); // ensures we walk through parameters always in same order so generated pseudo random seeds are always the same\n\tthis.seed={};\n\tfor(var pi=0;pi<paramNames.length;pi++) {\n\t\tvar f=paramNames[pi];\n\t\tvar param=params[f];\n\t\tvar seed={\n\t\t\tvalues: {},\n\t\t\tseeds:[],\n\t\t}\n\t\tvar vIndex=0;\n\t\tfor(var vi=0;vi<param.values.length;vi++)\n\t\t\tseed.values[param.values[vi]]=vIndex++;\n\t\tswitch(param.type) {\n\t\tcase \"array\":\n\t\t\tfor(var j=0;j<param.size;j++) {\n\t\t\t\tvar seeds0=[];\n\t\t\t\tfor(var i=0;i<vIndex;i++)\n\t\t\t\t\tseeds0.push(mt.genrand_int32());\n\t\t\t\tseed.seeds.push(seeds0);\n\t\t\t}\n\t\t\tseed.type=\"array\";\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tfor(var i=0;i<vIndex;i++)\n\t\t\t\tseed.seeds.push(mt.genrand_int32());\n\t\t\tseed.type=\"simple\";\n\t\t}\n\t\tthis.seed[f]=seed;\n\t}\n\t//console.log(\"Created zobrist\",this);\n}\n\nJocGame.Zobrist.prototype={\n\tupdate: function(zobrist,name) {\n\t\t//var zobrist0=zobrist;\n\t\tvar seed=this.seed[name];\n\t\tif(seed===undefined) {\n\t\t\tconsole.error(\"Unknown Zobrist parameter\",name);\n\t\t\treturn 0;\n\t\t}\n\t\tvar vIndex=seed.values[arguments[2]];\n\t\tif(vIndex===undefined) {\n\t\t\tconsole.error(\"Undeclared Zobrist value\",arguments[2],\"as param\",name);\n\t\t\treturn 0;\n\t\t}\n\t\tswitch(seed.type) {\n\t\tcase \"simple\":\n\t\t\tzobrist^=seed.seeds[vIndex];\n\t\t\tbreak;\n\t\tcase \"array\":\n\t\t\tvar seeds=seed.seeds[arguments[3]];\n\t\t\tif(seeds===undefined) {\n\t\t\t\tconsole.error(\"Undeclared Zobrist array index\",arguments[3],\"as param\",name);\n\t\t\t\treturn 0;\t\t\t\t\n\t\t\t}\n\t\t\tzobrist^=seeds[vIndex];\n\t\t\t//console.log(\"Zobrist\",zobrist0,\"=>\",name,\"array[\",arguments[2],\"] =\",arguments[3],\"=>\",zobrist);\n\t\t\tbreak;\n\t\t}\n\t\treturn zobrist;\n\t},\n}\n\n/*--- Levenshtein distance implementation ---*/\nJocGame.Levenshtein=function(e,f){if(e==f)return 0;var d=e.length,j=f.length;if(0===d)return j;if(0===j)return d;var b=!1;try{b=!\"0\"[0]}catch(m){b=!0}\nb&&(e=e.split(\"\"),f=f.split(\"\"));for(var b=Array(d+1),g=Array(d+1),a=0,h=0,i=0,a=0;a<d+1;a++)b[a]=a;for(var c=\"\",k=\"\",h=1;h<=j;h++){g[0]=h;k=f[h-1];\nfor(a=0;a<d;a++){var c=e[a],i=c==k?0:1,c=b[a+1]+1,l=g[a]+1,i=b[a]+i;l<c&&(c=l);i<c&&(c=i);g[a+1]=c}a=b;b=g;g=a}return b[d]};\n\n"]}