exports.model=Model={Game:{},Board:{},Move:{}},function(){var t;Model.Game.cbConstants={MASK:65535,FLAG_MOVE:65536,FLAG_CAPTURE:131072,FLAG_STOP:262144,FLAG_SCREEN_CAPTURE:524288,FLAG_CAPTURE_KING:1048576,FLAG_CAPTURE_NO_KING:2097152};var e="undefined"!=typeof Int32Array;Model.Game.cbUseTypedArrays=e,Model.Game.cbTypedArray=function(t){if(e){var i=new Int32Array(t.length);return i.set(t),i}for(var r=[],s=t.length,a=0;a<s;a++)r.push(t[a]);return r},Model.Game.cbShortRangeGraph=function(t,e,i,r){var s=this;void 0===r&&(r=196608);for(var a={},n=0;n<t.boardSize;n++)a[n]=[],(!i||n in i)&&e.forEach(function(e){var o=t.Graph(n,e);null!=o&&(!i||o in i)&&a[n].push(s.cbTypedArray([o|r]))});return a},Model.Game.cbLongRangeGraph=function(t,e,i,r,s){var a=this;void 0!==r&&null!=r||(r=196608),s||(s=1/0);for(var n={},o=0;o<t.boardSize;o++)n[o]=[],(!i||o in i)&&e.forEach(function(e){for(var h=[],c=t.Graph(o,e),p=0;null!=c&&(!i||c in i)&&(h.push(c|r),++p!=s);)c=t.Graph(c,e);h.length>0&&n[o].push(a.cbTypedArray(h))});return n},Model.Game.cbNullGraph=function(t){for(var e={},i=0;i<t.boardSize;i++)e[i]=[];return e},Model.Game.cbAuthorGraph=function(t){for(var e={},i=0;i<t.boardSize;i++){e[i]=[];for(var r=0;r<t.boardSize;r++)e[i].push([2293760|r])}return e},Model.Game.cbMergeGraphs=function(t){for(var e=[],i=0;i<t.boardSize;i++){e[i]=[];for(var r=1;r<arguments.length;r++)e[i]=e[i].concat(arguments[r][i])}return e},Model.Game.cbGetThreatGraph=function(){function t(e,i){for(var r in n){var s=n[r];if(!(s.p.length<i.length+1)){for(var a=!0,o=0;o<i.length;o++)if(i[o]!=s.p[o]){a=!1;break}if(a){var h=s.p[i.length],c=e[h];void 0===c&&(c={e:{}},e[h]=c),s.p.length==i.length+1&&(c.t=s.t,c.ts=s.ts,c.tk=s.tk,delete n[r]),i.push(h),t(c.e,i),i.pop()}}}}var e=this;this.cbUseScreenCapture=!1,this.cbUseCaptureKing=!1,this.cbUseCaptureNoKing=!1;for(var i={1:[],"-1":[]},r=[],s=0;s<this.g.boardSize;s++)this.g.pTypes.forEach(function(t,i){t.graph[s].forEach(function(t){for(var a=[],n=0;n<t.length;n++){var o=t[n];1048576&o?(e.cbUseCaptureKing=!0,a.unshift({d:65535&o,a:s,tk:i})):2097152&o?(e.cbUseCaptureNoKing=!0,a.unshift({d:65535&o,a:s,tnk:i})):131072&o?a.unshift({d:65535&o,a:s,t:i}):262144&o?a.unshift({d:65535&o,a:s}):524288&o&&(e.cbUseScreenCapture=!0,a.unshift({d:65535&o,a:s,ts:i}))}a.length>0&&r.push(a)})});var a={};r.forEach(function(t){t.forEach(function(e,i){var r=a[e.d];void 0===r&&(r={},a[e.d]=r);for(var s=[],n=i+1;n<t.length;n++)s.push(t[n].d);s.push(e.a);var o=s.join(","),h=r[o];void 0===h&&(h={p:s,t:{},ts:{},tk:{}},r[o]=h),void 0!==e.t?h.t[e.t]=!0:void 0!==e.tk?h.tk[e.tk]=!0:void 0!==e.ts&&(h.ts[e.ts]=!0)})});for(var s=0;s<e.g.boardSize;s++){var n=a[s],o={};t(o,[]),i[1][s]=o,i[-1][s]=o}return i},Model.Game.InitGame=function(){var e=this;this.cbVar=t=this.cbDefine(),this.g.boardSize=this.cbVar.geometry.boardSize,this.g.pTypes=this.cbGetPieceTypes(),this.g.threatGraph=this.cbGetThreatGraph(),this.g.distGraph=this.cbVar.geometry.GetDistances(),this.cbPiecesCount=0,this.g.castleablePiecesCount={1:0,"-1":0};for(var i in t.pieceTypes){var r=t.pieceTypes[i];if(r.castle){(r.initial||[]).forEach(function(t){e.g.castleablePiecesCount[t.s]++})}r.initial&&(this.cbPiecesCount+=r.initial.length)}for(var s=[],i=0;i<this.cbPiecesCount;i++)s.push(i);var a=Object.keys(t.pieceTypes);this.zobrist=new JocGame.Zobrist({board:{type:"array",size:this.cbVar.geometry.boardSize,values:s},who:{values:["1","-1"]},type:{type:"array",size:this.cbPiecesCount,values:a}})},Model.Game.cbGetPieceTypes=function(){for(var t=[],e={},i=0;i<this.cbVar.geometry.boardSize;i++)e[i]=[];for(var r in this.cbVar.pieceTypes){var s=this.cbVar.pieceTypes[r];t[r]={graph:s.graph||e,abbrev:s.abbrev||"",value:s.isKing?100:s.value||1,isKing:!!s.isKing,castle:!!s.castle,epTarget:!!s.epTarget,epCatch:!!s.epCatch}}return t},Model.Board.Init=function(t){this.zSign=0},Model.Board.InitialPosition=function(i){var r=this;this.board=e?new Int16Array(i.g.boardSize):[];for(var s=0;s<i.g.boardSize;s++)this.board[s]=-1;if(this.kings={},this.pieces=[],this.ending={1:!1,"-1":!1},this.lastMove=null,i.cbVar.castle&&(this.castled={1:!1,"-1":!1}),this.zSign=i.zobrist.update(0,"who",-1),this.noCaptCount=0,i.mInitial)i.mInitial.pieces.forEach(function(t){var e={};for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);r.pieces.push(e)}),i.mInitial.lastMove&&(this.lastMove={f:i.mInitial.lastMove.f,t:i.mInitial.lastMove.t}),void 0!==i.mInitial.noCaptCount&&(this.noCaptCount=i.mInitial.noCaptCount);else for(var a in i.cbVar.pieceTypes)for(var n=i.cbVar.pieceTypes[a],o=n.initial||[],h=0;h<o.length;h++){var c=o[h],p={s:c.s,t:parseInt(a),p:c.p,m:!1};this.pieces.push(p)}if(this.pieces.sort(function(t,e){if(t.s!=e.s)return e.s-t.s;var r=i.cbVar.pieceTypes[t.t].value||100,s=i.cbVar.pieceTypes[e.t].value||100;return r!=s?r-s:t.p-e.p}),this.pieces.forEach(function(t,e){t.i=e,r.board[t.p]=e,i.g.pTypes[t.t].isKing&&(r.kings[t.s]=t.p),r.zSign=i.zobrist.update(r.zSign,"board",e,t.p),r.zSign=i.zobrist.update(r.zSign,"type",t.t,e)}),i.mInitial&&i.mInitial.enPassant){var s=t.geometry.PosByName(i.mInitial.enPassant);if(s>=0){var l,u=t.geometry.C(s),v=t.geometry.R(s);l=1==i.mInitial.turn?t.geometry.POS(u,v-1):t.geometry.POS(u,v+1),this.epTarget={p:s,i:this.board[l]}}}},Model.Board.CopyFrom=function(t){if(e)this.board=new Int16Array(t.board.length),this.board.set(t.board);else{this.board=[];for(var i=t.board,r=i.length,s=0;s<r;s++)this.board.push(i[s])}this.pieces=[];for(var a=t.pieces.length,s=0;s<a;s++){var n=t.pieces[s];this.pieces.push({s:n.s,p:n.p,t:n.t,i:n.i,m:n.m})}this.kings={1:t.kings[1],"-1":t.kings[-1]},this.check=t.check,t.lastMove?this.lastMove={f:t.lastMove.f,t:t.lastMove.t,c:t.lastMove.c}:this.lastMove=null,this.ending={1:t.ending[1],"-1":t.ending[-1]},void 0!==t.castled&&(this.castled={1:t.castled[1],"-1":t.castled[-1]}),this.noCaptCount=t.noCaptCount,t.epTarget?this.epTarget={p:t.epTarget.p,i:t.epTarget.i}:this.epTarget=null,this.mWho=t.mWho,this.zSign=t.zSign},Model.Board.cbApplyCastle=function(t,e,i){var r=t.cbVar.castle[e.f+"/"+e.cg],s=r.r[r.r.length-1],a=this.pieces[this.board[e.cg]],n=r.k[r.k.length-1],o=this.pieces[this.board[e.f]];return i&&(this.zSign=t.zobrist.update(this.zSign,"board",a.i,e.cg),this.zSign=t.zobrist.update(this.zSign,"board",a.i,s),this.zSign=t.zobrist.update(this.zSign,"board",o.i,e.f),this.zSign=t.zobrist.update(this.zSign,"board",o.i,n)),a.p=s,a.m=!0,this.board[e.cg]=-1,o.p=n,o.m=!0,this.board[e.f]=-1,this.board[s]=a.i,this.board[n]=o.i,this.castled[a.s]=!0,this.kings[o.s]=n,[{i:a.i,f:s,t:-1},{i:o.i,f:n,t:e.f,kp:e.f,who:o.s,m:!1},{i:a.i,f:-1,t:e.cg,m:!1,cg:!1}]},Model.Board.cbQuickApply=function(t,e){if(void 0!==e.cg)return this.cbApplyCastle(t,e,!1);var i=[],r=this.board[e.f],s=this.pieces[r];if(null!=e.c){i.unshift({i:e.c,f:-1,t:this.pieces[e.c].p});var a=this.pieces[e.c];this.board[a.p]=-1,a.p=-1}var n=this.kings[s.s];return t.g.pTypes[s.t].isKing&&(this.kings[s.s]=e.t),i.unshift({i:r,f:e.t,t:e.f,kp:n,who:s.s,ty:s.t}),s.p=e.t,void 0!==e.pr&&(s.t=e.pr),this.board[e.f]=-1,this.board[e.t]=r,i},Model.Board.cbQuickUnapply=function(t,e){for(var i=0;i<e.length;i++){var r=e[i],s=this.pieces[r.i];r.f>=0&&(s.p=-1,this.board[r.f]=-1),r.t>=0&&(s.p=r.t,this.board[r.t]=r.i),void 0!==r.m&&(s.m=r.m),void 0!==r.kp&&(this.kings[r.who]=r.kp),void 0!=r.ty&&(s.t=r.ty),void 0!=r.cg&&(this.castled[s.s]=r.cg)}},Model.Board.ApplyMove=function(t,e){var i=this.pieces[this.board[e.f]];if(void 0!==e.cg)this.cbApplyCastle(t,e,!0);else{if(this.zSign=t.zobrist.update(this.zSign,"board",i.i,e.f),this.board[i.p]=-1,void 0!==e.pr&&(this.zSign=t.zobrist.update(this.zSign,"type",i.t,i.i),i.t=e.pr,this.zSign=t.zobrist.update(this.zSign,"type",i.t,i.i)),null!=e.c){var r=this.pieces[e.c];this.zSign=t.zobrist.update(this.zSign,"board",r.i,r.p),this.board[r.p]=-1,r.p=-1,r.m=!0,this.noCaptCount=0}else this.noCaptCount++;i.p=e.t,i.m=!0,this.board[e.t]=i.i,this.zSign=t.zobrist.update(this.zSign,"board",i.i,e.t),t.g.pTypes[i.t].isKing&&(this.kings[i.s]=e.t)}this.check=!!e.ck,this.lastMove={f:e.f,t:e.t,c:e.c},void 0!==e.ko&&(this.ending[i.s]=e.ko),void 0!==e.ept?this.epTarget={p:e.ept,i:i.i}:this.epTarget=null,this.zSign=t.zobrist.update(this.zSign,"who",-this.mWho),this.zSign=t.zobrist.update(this.zSign,"who",this.mWho)},Model.Board.Evaluate=function(i){function r(e){var i=1/0;for(var r in t.geometry.corners)i=Math.min(i,h.distGraph[a.kings[e]][r]);return i-Math.sqrt(h.boardSize)}var s="debug"==arguments[3],a=this;this.mEvaluation=0;var n,o=this.mWho,h=i.g;if(e)n={1:{count:new Uint8Array(h.pTypes.length),byType:{}},"-1":{count:new Uint8Array(h.pTypes.length),byType:{}}};else{n={1:{count:[],byType:{}},"-1":{count:[],byType:{}}};for(var c=0;c<h.pTypes.length;c++)n[1].count[c]=n[-1].count[c]=0}if(i.mOptions.preventRepeat&&i.GetRepeatOccurence(this)>2)return this.mFinished=!0,void(this.mWinner=i.cbOnPerpetual?o*i.cbOnPerpetual:JocGame.DRAW);for(var p={1:0,"-1":0},l={1:h.distGraph[this.kings[-1]],"-1":h.distGraph[this.kings[1]]},u={1:0,"-1":0},v={1:0,"-1":0},f={1:0,"-1":0},d={1:0,"-1":0},g={1:!1,"-1":!1},b=this.pieces,m=b.length,c=0;c<m;c++){var y=b[c];if(y.p>=0){var M=y.s,k=h.pTypes[y.t];k.isKing?g[M]=y.m:p[M]+=k.value,k.castle&&!y.m&&d[M]++,v[M]++,u[M]+=l[M][y.p],f[M]+=t.geometry.distEdge[y.p];var S=n[M];S.count[y.t]++;var G=S.byType;void 0===G[y.t]?G[y.t]=[y]:G[y.t].push(y)}}if(this.lastMove&&null!=this.lastMove.c){var y=this.pieces[this.board[this.lastMove.t]];p[-y.s]+=this.cbStaticExchangeEval(i,y.p,y.s,{piece:y})}var C={1:0,"-1":0},z={1:0,"-1":0},T={1:0,"-1":0};this.ending[1]&&(z[1]=(u[1]-Math.sqrt(h.boardSize))/v[1],t.geometry.corners&&(T[1]=r(1))),this.ending[-1]&&(z[-1]=(u[-1]-Math.sqrt(h.boardSize))/v[-1],t.geometry.corners&&(T[1]=r(-1)));var A={pieceValue:p[1]-p[-1],pieceValueRatio:(p[1]-p[-1])/(p[1]+p[-1]+1),posValue:f[1]-f[-1],averageDistKing:u[1]/v[1]-u[-1]/v[-1],check:this.check?-o:0,endingKingFreedom:C[1]-C[-1],endingDistKing:z[1]-z[-1],distKingCorner:T[1]-T[-1]};t.castle&&(A.castle=(this.castled[1]?1:g[1]?0:d[1]/(h.castleablePiecesCount[1]+1))-(this.castled[-1]?1:g[-1]?0:d[-1]/(h.castleablePiecesCount[-1]+1))),t.evaluate&&t.evaluate.call(this,i,A,n);var P=i.mOptions.levelOptions;for(var E in A){var w=A[E],I=P[E+"Factor"]||0,W=w*I;s&&console.log(E,"=",w,"*",I,"=>",W),this.mEvaluation+=W}s&&console.log("Evaluation",this.mEvaluation)},Model.Board.cbGeneratePseudoLegalMoves=function(t){function e(e,s){var a=t.cbVar.promote;if(!a)return void r.push(s);var n=a.call(i,t,e,s);if(null!=n)if(0==n.length)r.push(s);else if(1==n.length)s.pr=n[0],r.push(s);else for(var o=0;o<n.length;o++){var h=n[o];r.push({f:s.f,t:s.t,c:s.c,pr:h,ept:s.ept,ep:s.ep,a:s.a})}}for(var i=this,r=[],s=t.cbVar,a=this.mWho,n=!s.castle||this.check||this.castled[a]?null:[],o=-1,h=this.pieces.length,c=0;c<h;c++){var p=this.pieces[c];if(!(p.p<0||p.s!=a)){var l=t.g.pTypes[p.t];l.isKing&&(p.m?n=null:o=p),n&&l.castle&&!p.m&&n.push(p);var u,v;u=l.graph[p.p],v=u.length;for(var f=0;f<v;f++)for(var d=u[f],g=!1,b=d.length,m=null,y=0;y<b;y++){var M=d[y],k=65535&M,S=this.board[k];if(!(S<0)||l.epCatch&&this.epTarget&&this.epTarget.p==k){if(!(524288&M)){var G;G=S<0?this.pieces[this.epTarget.i]:this.pieces[S],!(G.s!=p.s&&131072&M)||1048576&M&&!t.g.pTypes[G.t].isKing||2097152&M&&t.g.pTypes[G.t].isKing||e(p,{f:p.p,t:k,c:G.i,a:l.abbrev,ep:S<0});break}if(g){var G=this.pieces[S];G.s!=p.s&&e(p,{f:p.p,t:k,c:G.i,a:l.abbrev});break}g=!0}else 65536&M&&0==g&&e(p,{f:p.p,t:k,c:null,a:l.abbrev,ept:null!=m&&l.epTarget?m:void 0});m=k}}}if(n)for(var c=0;c<n.length;c++){var C=n[c],z=t.cbVar.castle[o.p+"/"+C.p];if(z){for(var T=!0,f=0;f<z.r.length;f++){var A=z.r[f];if(this.board[A]>=0&&A!=o.p&&A!=C.p){T=!1;break}}if(T){for(var P=!0,f=0;f<z.k.length;f++){var A=z.k[f];if(this.board[A]>=0&&A!=C.p&&A!=o.p||this.cbGetAttackers(t,A,a).length>0){P=!1;break}}P&&r.push({f:o.p,t:z.k[z.k.length-1],c:null,cg:C.p})}}}return r},Model.Board.cbStaticExchangeEval=function(t,e,i,r){var s=0,a=this.cbGetSmallestAttacker(t,e,i);if(a){var n=this.mWho;this.mWho=a.s;var o=this.cbQuickApply(t,{f:a.p,t:e,c:r.piece.i}),h=t.g.pTypes[r.piece.t].value;r.piece=a,s=Math.max(0,h-this.cbStaticExchangeEval(t,e,-i,r)),this.cbQuickUnapply(t,o),this.mWho=n}return s},Model.Board.cbGetSmallestAttacker=function(t,e,i){var r=this.cbGetAttackers(t,e,i);if(0==r.length)return null;for(var s=1/0,a=null,n=r.length,o=0;o<n;o++){var h=r[o],c=t.g.pTypes[h.t].value;c<s&&(s=c,a=h)}return a},Model.Board.cbCollectAttackers=function(t,e,i,r){for(var s in e){var a=e[s],n=this.board[s];if(n<0)this.cbCollectAttackers(t,a.e,i,r);else{var o=this.pieces[n];o.s==-t&&(a.t&&o.t in a.t||r&&a.tk&&o.t in a.tk)&&i.push(o)}}},Model.Board.cbCollectAttackersScreen=function(t,e,i,r,s){for(var a in e){var n=e[a],o=this.board[a];if(o<0)this.cbCollectAttackersScreen(t,n.e,i,r,s);else{var h=this.pieces[o];!s&&h.s==-t&&(n.t&&h.t in n.t||r&&n.tk&&h.t in n.tk)?i.push(h):s?s&&h.s==-t&&n.ts&&h.t in n.ts&&i.push(h):this.cbCollectAttackersScreen(t,n.e,i,r,!0)}}},Model.Board.cbGetAttackers=function(t,e,i,r){var s=[];return t.cbUseScreenCapture?this.cbCollectAttackersScreen(i,t.g.threatGraph[i][e],s,r,!1):this.cbCollectAttackers(i,t.g.threatGraph[i][e],s,r),s},Model.Board.GenerateMoves=function(t){var e=this.cbGeneratePseudoLegalMoves(t);this.mMoves=[];for(var i=!0,r=this.kings[this.mWho],s=e.length,a=0;a<s;a++){var n=e[a],o=this.cbQuickApply(t,n);if(!(this.cbGetAttackers(t,this.kings[this.mWho],this.mWho,!0).length>0)){var h=this.cbGetAttackers(t,this.kings[-this.mWho],-this.mWho,!0).length>0;n.ck=h,this.mMoves.push(n),n.f!=r&&(i=!1)}this.cbQuickUnapply(t,o)}if(0==this.mMoves.length)this.mFinished=!0,this.mWinner=t.cbOnStaleMate?t.cbOnStaleMate*this.mWho:JocGame.DRAW,this.check&&(this.mWinner=-this.mWho);else if(this.ending[this.mWho]){if(!i)for(var a=0;a<this.mMoves.length;a++)this.mMoves[a].ko=!1}else if(!this.ending[this.mWho]&&i&&!this.check)for(var a=0;a<this.mMoves.length;a++)this.mMoves[a].ko=!0},Model.Board.GetSignature=function(){return this.zSign},Model.Move.Init=function(t){for(var e in t)t.hasOwnProperty(e)&&(this[e]=t[e])},Model.Move.Equals=function(t){return this.f==t.f&&this.t==t.t&&this.pr==t.pr},Model.Move.CopyFrom=function(t){this.Init(t)},Model.Move.ToString=function(){if(this.compact)return this.compact;var e;if(void 0!==this.cg?e=t.castle[this.f+"/"+this.cg].n:(e=this.a||"",e+=t.geometry.PosName(this.f),null==this.c?e+="-":e+="x",e+=t.geometry.PosName(this.t)),void 0!==this.pr){var i=t.pieceTypes[this.pr];i&&i.abbrev&&i.abbrev.length>0&&!i.silentPromo&&(e+="="+i.abbrev)}return this.ck&&(e+="+"),e},Model.Board.CompactMoveString=function(e,i,r){"function"!=typeof i.ToString&&(i=e.CreateMove(i));var s=i.ToString(),a=/^([A-Z]?)([a-z])([1-9][0-9]*)([-x])([a-z])([1-9][0-9]*)(.*?)$/.exec(s);if(!a)return s;var n=a[7];if(r||(r={}),r.value||(r.value=[]),0==r.value.length){var o=this.mMoves;this.mMoves&&0!=this.mMoves.length||this.GenerateMoves(e);for(var h=0;h<this.mMoves.length;h++){var c=this.mMoves[h];"function"!=typeof c.ToString&&(c=e.CreateMove(c)),r.value.push({str:c.ToString(),move:c})}this.mMoves=o}var p=[];if(r.value.forEach(function(t){var e=/^([A-Z]?[a-z][1-9][0-9]*[-x][a-z][1-9][0-9]*)(.*?)$/.exec(t.str);e&&t.move.t==i.t&&(t.move.a||"")==a[1]&&e[2]==n&&p.push(t.move)}),1==p.length)return""==a[1]&&"x"==a[4]?a[2]+"x"+a[5]+a[6]+a[7]:a[1]+("x"==a[4]?"x":"")+a[5]+a[6]+a[7];if(t.geometry.CompactCrit)for(var l="",h=0;;h++){var u=t.geometry.CompactCrit(i.f,h);if(null==u)return s;l+=u;for(var v=[],f=0;f<p.length;f++){var d=p[f];t.geometry.CompactCrit(d.f,h)==u&&v.push(d)}if(console.assert(v.length>0),1==v.length)return a[1]+l+("x"==a[4]?"x":"")+a[5]+a[6]+a[7];p=v}return s},Model.Board.cbIntegrity=function(t){function e(t,e){t||console.error(e)}for(var i=this,r=0;r<this.board.length;r++){var s=this.board[r];if(s>=0){var a=i.pieces[s];e(void 0!==a,"no piece at pos"),e(a.p==r,"piece has different pos")}}for(var s=0;s<this.pieces.length;s++){var a=this.pieces[s];a.p>=0&&e(i.board[a.p]==s,"board index mismatch")}},Model.Game.Import=function(e,i){var r,s=[],a={1:{},"-1":{}},n=null,o=0;if("pjn"==e){var h={status:!1,error:"parse"},c=i.split(" ");if(6!=c.length)return console.warn("FEN should have 6 parts"),h;var p=c[0].split("/"),l=t.geometry.fenHeight||t.geometry.height;if(p.length!=l)return console.warn("FEN board should have",l,"rows, got",p.length),h;var u={};for(var v in t.pieceTypes){var f=t.pieceTypes[v],d=f.fenAbbrev||f.abbrev||"X";u[d.toUpperCase()]={s:1,t:v},u[d.toLowerCase()]={s:-1,t:v}}var g=t.geometry.FenRowPos||function(e,i){return(t.geometry.height-1-e)*t.geometry.width+i};if(p.forEach(function(e,i){for(var r=0,a=0;a<e.length;a++){var n=e.substr(a,1),o=u[n];if(void 0!==o){var c=g(i,r);r++;for(var p={s:o.s,t:o.t,p:c},l=!0,v=t.pieceTypes[p.t].initial||[],f=0;f<v.length;f++){var d=v[f];d.s==p.s&&d.p==c&&(l=!1)}p.m=l,s.push(p)}else{if(isNaN(parseInt(n)))return console.warn("FEN invalid board spec",n),h;r+=parseInt(n)}}}),s.sort(function(t,e){return e.s-t.s}),"w"==c[1])r=1;else{if("b"!=c[1])return console.warn("FEN invalid turn spec",c[1]),h;r=-1}a[1].k=c[2].indexOf("K")>=0,a[1].q=c[2].indexOf("Q")>=0,a[-1].k=c[2].indexOf("k")>=0,a[-1].q=c[2].indexOf("q")>=0,n="-"==c[3]?null:c[3];var b=parseInt(c[4]);isNaN(b)||(o=b);var m={pieces:s,turn:r,castle:a,enPassant:n,noCaptCount:o};return t.importGame&&t.importGame.call(this,m,e,i),{status:!0,initial:m}}return{status:!1,error:"unsupported"}}}(),function(){Model.Game.cbBoardGeometrySmess=function(t,e){function i(e){return e%t}function r(e){return Math.floor(e/t)}function s(e,i){return i*t+e}function a(a,n){var o=i(a),h=r(a),c=o+n[0],p=h+n[1];return c<0||c>=t||p<0||p>=e?null:s(c,p)}function n(t){return String.fromCharCode("a".charCodeAt(0)+i(t))+(r(t)+1)}function o(t){var e=/^([a-z])([0-9]+)$/.exec(t);return e?s(e[1].charCodeAt(0)-"a".charCodeAt(0),parseInt(e[2])-1):-1}function h(t,e){return 0==e?String.fromCharCode("a".charCodeAt(0)+i(t)):1==e?r(t)+1:null}function c(){if(void 0!==p)return p;p={};for(var i=0;i<t*e;i++)p[i]={},p[i][i]=0;for(var r={0:[-1,1],1:[0,1],2:[1,1],3:[1,0],4:[1,-1],5:[0,-1],6:[-1,-1],7:[-1,0]},s=!0;s;){s=!1;for(var i=0;i<t*e;i++){for(var n=[],o=0;o<8;o++)l.cbSmessGraph[i]&1<<o&&n.push(r[o]);n.forEach(function(r){var n=a(i,r);if(null!=n){1!=p[i][n]&&(p[i][n]=1,s=!0);for(var o=0;o<t*e;o++)o!=i&&(void 0===p[i][o]&&void 0!==p[n][o]?(p[i][o]=p[n][o]+1,s=!0):void 0!==p[i][o]&&void 0!==p[n][o]&&p[i][o]>p[n][o]+1&&(p[i][o]=p[n][o]+1,s=!0))}})}}return p}var p,l=this;return{boardSize:t*e,width:t,height:e,C:i,R:r,POS:s,Graph:a,PosName:n,PosByName:o,CompactCrit:h,GetDistances:c,distEdge:function(){for(var s=[],a=0;a<t*e;a++){var n=i(a),o=r(a);s[a]=Math.min(n,Math.abs(t-n-1),o,Math.abs(e-o-1))}return s}(),corners:function(){var i={};return i[s(0,0)]=1,i[s(0,e-1)]=1,i[s(t-1,0)]=1,i[s(t-1,e-1)]=1,i}(),distPromo:function(){var i={1:{},"-1":{}},r=c();return["1","-1"].forEach(function(s){for(var a=0;a<t*e;a++){var n=1/0;for(var o in l.cbSmessPromoPoss[s]){var h=r[a][o];h<n&&(i[s][a]=h,n=h)}}}),i}()}},Model.Game.cbSmessGraph=[2,138,138,138,138,138,130,34,10,170,138,170,146,34,42,168,85,136,85,170,162,34,170,162,255,162,128,193,28,8,42,255,42,170,34,42,170,85,136,85,138,162,34,41,170,168,170,160,34,40,168,168,168,168,168,32],Model.Game.cbSmessPromoPoss={1:{50:1,51:1,53:1,54:1},"-1":{1:1,2:1,4:1,5:1}},Model.Game.cbSmessPieceGraph=function(t,e){for(var i=this,r=this.cbConstants.FLAG_MOVE|this.cbConstants.FLAG_CAPTURE,s={0:[-1,1],1:[0,1],2:[1,1],3:[1,0],4:[1,-1],5:[0,-1],6:[-1,-1],7:[-1,0]},a={},n=0;n<t.boardSize;n++){a[n]=[];for(var o=[],h=0;h<8;h++)this.cbSmessGraph[n]&1<<h&&o.push(s[h]);o.forEach(function(s){for(var o=[],h=t.Graph(n,s);null!=h&&(o.push(h|r),e);)h=t.Graph(h,s);o.length>0&&a[n].push(i.cbTypedArray(o))})}return a}}(),function(){var t=Model.Game.cbBoardGeometrySmess(7,8);Model.Game.cbDefine=function(){return{geometry:t,pieceTypes:{0:{name:"ninny",aspect:"sm-pawn",graph:this.cbSmessPieceGraph(t,!1),value:1,abbrev:"",fenAbbrev:"P",initial:[{s:1,p:7},{s:1,p:8},{s:1,p:9},{s:1,p:10},{s:1,p:11},{s:1,p:12},{s:1,p:13},{s:-1,p:42},{s:-1,p:43},{s:-1,p:44},{s:-1,p:45},{s:-1,p:46},{s:-1,p:47},{s:-1,p:48}]},1:{name:"numskull",aspect:"sm-skull",graph:this.cbSmessPieceGraph(t,!0),value:4,abbrev:"R",initial:[{s:1,p:1},{s:1,p:2},{s:1,p:4},{s:1,p:5},{s:-1,p:50},{s:-1,p:51},{s:-1,p:53},{s:-1,p:54}]},2:{name:"brain",aspect:"sm-brain",isKing:!0,graph:this.cbSmessPieceGraph(t,!1),abbrev:"K",initial:[{s:1,p:3},{s:-1,p:52}]}},promote:function(t,e,i){return 0==e.t&&i.t in t.cbSmessPromoPoss[e.s]?[1]:[]},evaluate:function(t,e,i){var r=i[1].count,s=i[-1].count;0==r[0]&&0==r[1]&&0==s[0]&&0==s[1]&&(this.mFinished=!0,this.mWinner=JocGame.DRAW),this.noCaptCount>=100&&(this.mFinished=!0,this.mWinner=JocGame.DRAW);var a,n=t.cbUseTypedArrays?new Int8Array(5):[0,0,0,0,0],o=t.cbVar.geometry.distPromo,h=i[1].byType[0];if(h){a=h.length;for(var c=0;c<a;c++)switch(o[1][h[c].p]){case 2:n[0]++;break;case 3:n[1]++;break;case 4:n[2]++;break;case 5:n[3]++;break;case 6:n[4]++}}if(h=i[-1].byType[2]){a=h.length;for(var c=0;c<a;c++)switch(o[-1][h[c].p]){case 1:n[0]--;break;case 2:n[1]--;break;case 3:n[2]--;break;case 4:n[3]--;break;case 5:n[4]--}}0!=n[0]&&(e.distPawnPromo1=n[0]),0!=n[1]&&(e.distPawnPromo2=n[1]),0!=n[2]&&(e.distPawnPromo3=n[2]),0!=n[3]&&(e.distPawnPromo4=n[3]),0!=n[4]&&(e.distPawnPromo5=n[4])}}}}();